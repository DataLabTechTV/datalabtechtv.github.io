<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface &#183; Data Lab Tech TV</title>
<meta name=title content="LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface &#183; Data Lab Tech TV"><meta name=description content="Learn how to build a CLI for your monorepo, with cobra and the charm stack."><meta name=keywords content="iam,s3,go,object-store,aws,cli,client,video,"><link rel=canonical href=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/><link type=text/css rel=stylesheet href=/css/main.bundle.min.36c3cd7950e4533fa7da3150d972e3edf34d07f83c0264ff04cad0969dfdb3b8a7065b0ed6c730c6d34a7bad516cfc6f6a5917ab1fdb10b25f481f8a17b54c16.css integrity="sha512-NsPNeVDkUz+n2jFQ2XLj7fNNB/g8AmT/BMrQlp39s7inBlsO1scwxtNKe61RbPxvalkXqx/bELJfSB+KF7VMFg=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.52b8d61b061c90a738102a0eac69eaa1479fdf5de882a0b0741d7515240617156a6c4477fcc91f9c962062804fe62d2932bb9f57d0aded208c762c2e1ed2e202.js integrity="sha512-UrjWGwYckKc4ECoOrGnqoUef313ogqCwdB11FSQGFxVqbER3/MkfnJYgYoBP5i0pMrufV9Ct7SCMdiwuHtLiAg==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/"><meta property="og:site_name" content="Data Lab Tech TV"><meta property="og:title" content="LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface"><meta property="og:description" content="Learn how to build a CLI for your monorepo, with cobra and the charm stack."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-27T12:00:00+01:00"><meta property="article:modified_time" content="2026-01-28T08:15:00+01:00"><meta property="article:tag" content="Iam"><meta property="article:tag" content="S3"><meta property="article:tag" content="Go"><meta property="article:tag" content="Object-Store"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Cli"><meta property="og:image" content="https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/feature.jpeg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/feature.jpeg"><meta name=twitter:title content="LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface"><meta name=twitter:description content="Learn how to build a CLI for your monorepo, with cobra and the charm stack."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface","headline":"LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface","description":"Learn how to build a CLI for your monorepo, with cobra and the charm stack.","abstract":"Summary # Learn how to build a CLI for your monorepo, with cobra and the charm stack.","inLanguage":"en","url":"https:\/\/datalabtechtv.com\/posts\/labstore-part-5-cli-tooling\/","author":{"@type":"Person","name":"Data Lab Tech"},"copyrightYear":"2026","dateCreated":"2026-01-27T12:00:00\u002b01:00","datePublished":"2026-01-27T12:00:00\u002b01:00","dateModified":"2026-01-28T08:15:00\u002b01:00","keywords":["iam","s3","go","object-store","aws","cli","client","video"],"mainEntityOfPage":"true","wordCount":"5386"}]</script><meta name=author content="Data Lab Tech"><link href=https://youtube.com/@DataLabTechTV rel=me><link href=https://bsky.app/profile/datalabtechtv.com rel=me><link href=https://github.com/DataLabTechTV rel=me><link href=https://discord.gg/6xpe827ANZ rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VQTLJTJJ7T"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied"}),gtag("js",new Date),gtag("config","G-VQTLJTJJ7T",{anonymize_ip:!0,allow_google_signals:!1})</script><script>MathJax={tex:{inlineMath:[["$","$"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js></script><style>.medium-zoom-overlay{background:rgba(0,0,0,.9)!important;z-index:100}.of-wide{width:150%;margin-left:-25%;height:auto}.of-narrow{width:125%;height:auto}</style><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 min-h-[130px] opacity-65 pl-[24px] pr-[24px] bg-gradient-to-b from-neutral from-60% dark:from-neutral-800 to-transparent mix-blend-normal" style=z-index:80></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div><a href=/ class=flex><span class=sr-only>Data Lab Tech TV</span>
<img src=/img/logo.png width=450 height=450 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Data Lab Tech TV"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Data Lab Tech TV</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Blog</p></a><a href=https://youtube.com/@DataLabTechTV target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></span><p class="text-base font-medium" title>YouTube</p></a><a href=https://bsky.app/profile/datalabtechtv.com target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></span><p class="text-base font-medium" title>Bluesky</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><div><div class="cursor-pointer flex items-center nested-menu"><a class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title>Categories
</a><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/categories/data-science/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Data Science</p></a><a href=/categories/data-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Data Engineering</p></a><a href=/categories/mlops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>MLOps</p></a><a href=/categories/devops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>DevOps</p></a><a href=/categories/software-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Software Engineering</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Philosophy of Technology</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Blog</p></a></li><li class=mt-1><a href=https://youtube.com/@DataLabTechTV target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></div><p class="text-bg font-bg" title>YouTube</p></a></li><li class=mt-1><a href=https://bsky.app/profile/datalabtechtv.com target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></div><p class="text-bg font-bg" title>Bluesky</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Categories</p><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=/categories/data-science/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Data Science</p></a></li><li class=mt-1><a href=/categories/data-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Data Engineering</p></a></li><li class=mt-1><a href=/categories/mlops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>MLOps</p></a></li><li class=mt-1><a href=/categories/devops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>DevOps</p></a></li><li class=mt-1><a href=/categories/software-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Software Engineering</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Philosophy of Technology</p></a></li><li class=mb-2></li></ul></div></label></div></div></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/img/background_hu5250322968290309648.png)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-30 dark:opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-01-27T12:00:00+01:00>27 January 2026</time><span class="px-2 text-primary-500">&#183;</span><span>5386 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">26 mins</span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/categories/software-engineering/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Software Engineering
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/iam/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Iam
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/s3/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">S3
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/go/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Go
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/object-store/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Object-Store
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/aws/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Aws
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/cli/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cli
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/client/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Client
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/video/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Video</span></span></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#taming-the-cli>Taming the CLI</a></li><li><a href=#changes-to-the-codebase>Changes to the Codebase</a><ul><li><a href=#centralizing-commands>Centralizing Commands</a></li><li><a href=#using-go-work-for-development>Using <code>go work</code> for Development</a></li><li><a href=#building-and-ci>Building and CI</a><ul><li><a href=#linting-with-pre-commit>Linting with Pre-Commit</a></li><li><a href=#github-actions>GitHub Actions</a></li><li><a href=#makefile>Makefile</a></li></ul></li></ul></li><li><a href=#using-cobra-to-produce-commands>Using Cobra to Produce Commands</a><ul><li><a href=#root-command>Root Command</a></li><li><a href=#positional-arguments>Positional Arguments</a></li><li><a href=#run-hooks>Run Hooks</a></li><li><a href=#annotations>Annotations</a></li><li><a href=#flags-and-subcommands>Flags and Subcommands</a></li><li><a href=#help-message>Help Message</a></li><li><a href=#shell-autocompletion>Shell Autocompletion</a></li></ul></li><li><a href=#managing-multiple-http-services>Managing Multiple HTTP Services</a></li><li><a href=#managing-client-side-credentials>Managing Client-Side Credentials</a></li><li><a href=#first-look-at-tui-design>First Look at TUI Design</a><ul><li><a href=#color-palette>Color Palette</a></li><li><a href=#styling>Styling</a></li><li><a href=#generics-and-type-constraints-in-go>Generics and Type Constraints in Go</a></li><li><a href=#designing-a-progress-bar-component>Designing a Progress Bar Component</a><ul><li><a href=#processing-update-events>Processing Update Events</a></li><li><a href=#running-and-consuming-channels>Running and Consuming Channels</a></li></ul></li></ul></li><li><a href=#one-binary-to-rule-them-all>One Binary to Rule Them All</a><ul><li><a href=#embedding-and-serving-the-web-ui>Embedding and Serving the Web UI</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#taming-the-cli>Taming the CLI</a></li><li><a href=#changes-to-the-codebase>Changes to the Codebase</a><ul><li><a href=#centralizing-commands>Centralizing Commands</a></li><li><a href=#using-go-work-for-development>Using <code>go work</code> for Development</a></li><li><a href=#building-and-ci>Building and CI</a><ul><li><a href=#linting-with-pre-commit>Linting with Pre-Commit</a></li><li><a href=#github-actions>GitHub Actions</a></li><li><a href=#makefile>Makefile</a></li></ul></li></ul></li><li><a href=#using-cobra-to-produce-commands>Using Cobra to Produce Commands</a><ul><li><a href=#root-command>Root Command</a></li><li><a href=#positional-arguments>Positional Arguments</a></li><li><a href=#run-hooks>Run Hooks</a></li><li><a href=#annotations>Annotations</a></li><li><a href=#flags-and-subcommands>Flags and Subcommands</a></li><li><a href=#help-message>Help Message</a></li><li><a href=#shell-autocompletion>Shell Autocompletion</a></li></ul></li><li><a href=#managing-multiple-http-services>Managing Multiple HTTP Services</a></li><li><a href=#managing-client-side-credentials>Managing Client-Side Credentials</a></li><li><a href=#first-look-at-tui-design>First Look at TUI Design</a><ul><li><a href=#color-palette>Color Palette</a></li><li><a href=#styling>Styling</a></li><li><a href=#generics-and-type-constraints-in-go>Generics and Type Constraints in Go</a></li><li><a href=#designing-a-progress-bar-component>Designing a Progress Bar Component</a><ul><li><a href=#processing-update-events>Processing Update Events</a></li><li><a href=#running-and-consuming-channels>Running and Consuming Channels</a></li></ul></li></ul></li><li><a href=#one-binary-to-rule-them-all>One Binary to Rule Them All</a><ul><li><a href=#embedding-and-serving-the-web-ui>Embedding and Serving the Web UI</a></li></ul></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">Summary<div id=summary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h2><p>Learn how to build a CLI for your monorepo, with <a href=https://cobra.dev/ target=_blank>cobra</a> and the <a href=https://charm.land/libs/ target=_blank>charm stack</a>. With this blog post and video, you will easily learn the basics—and beyond—on how to use <code>cobra</code> for building a CLI, from persistent pre runs that propagate, to command annotations for custom control, or handling your own errors manually. We&rsquo;ll also teach you how to manage multiple services, on separate ports, within a single <code>serve</code> command, how to manage client-side credentials easily, and how to design a basic TUI, including color palettes and styling with <a href=https://github.com/charmbracelet/lipgloss target=_blank>lipgloss</a>, as well as custom components with <a href=https://github.com/charmbracelet/bubbletea target=_blank>bubbletea</a>. Finally, you&rsquo;ll learn how easy it is to embed a static site into a Go binary so that you can serve your own web UI. One binary to rule them all!</p><p>Follow this series with IllumiKnow Labs, and let&rsquo;s see where this journey takes us. Hopefully you&rsquo;ll learn a lot along the way!</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%><iframe src=https://www.youtube.com/embed/fvjtAzvGVGI frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin allowfullscreen style=position:absolute;top:0;left:0;width:100%;height:100%>></iframe></div><h2 class="relative group">Taming the CLI<div id=taming-the-cli class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#taming-the-cli aria-label=Anchor>#</a></span></h2><p>Creating a command line interface is not, by itself, a hard task. And it&rsquo;s not any different with Go. In fact, this is quite straightforward when using <a href=https://cobra.dev/ target=_blank>Cobra</a>.</p><p>In this blog post, we describe our approach to accommodating the CLI for LabStore:</p><ul><li>Changes to the codebase, including to the CI workflow;</li><li>Basics of Cobra for CLI design;</li><li>How to cleanly manage multiple HTTP services in a single <code>serve</code> command;</li><li>How generics and type constraints helped simplify a few CLI display tasks;</li><li>The new <code>credentials.yaml</code> file, meant for direct user editing;</li><li>A light introduction to TUI design, focusing on styling and the progress bar component;</li><li>File embedding in Go, and how to serve a web UI as a static site, directly from Go, via <code>http.FileServer</code>.</li></ul><h2 class="relative group">Changes to the Codebase<div id=changes-to-the-codebase class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#changes-to-the-codebase aria-label=Anchor>#</a></span></h2><h3 class="relative group">Centralizing Commands<div id=centralizing-commands class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#centralizing-commands aria-label=Anchor>#</a></span></h3><p>We started from two main Go projects, <code>backend</code> and <code>cli</code>, we well as a secondary <code>shared</code> directory to drop any additional subprojects, required by other projects in our monorepo. Our <code>backend</code> project already provided its own <code>cmd/labstore-server</code> implemented in Cobra, but it quickly became clear that this should be centralized in <code>cli</code>. Initially, we were considering importing <code>cmd/labstore-server/serve.go</code> directly from <code>cli</code>, but this would essentially make the <code>labstore-server</code> binary irrelevant, so we opted to move all commands into <code>cli</code>.</p><p>We dropped <code>backend/cmd/labstore-server</code> and consolidated its commands into <code>cli/cmd/labstore</code> instead, thus turning <code>backend</code> into a library, which we renamed to <code>server</code>, for clarity.</p><p>We also started a new <code>client</code> project, a library to handle S3 and IAM requests. At first, we dropped it into <code>shared/client</code>, but we quickly realized this should be a top-level project, so it now lives in the root of the repo as <code>client</code>.</p><p>Finally, because we had to reuse a lot of code from <code>server</code> (or, previously, <code>backend</code>), we ended up having to do some refactoring, so that this could be exposed under <code>server/pkg</code>. This included types and errors, as well as most of the authentication logic and other common components, like logging or helpers. In the future, we&rsquo;ll most likely refactor some of these into subprojects, under <code>shared</code>, as well as split the <code>helpers</code> into semantically clearer packages.</p><p>For now, this is what we expose from <code>server</code>:</p><pre tabindex=0><code>server/pkg/
├── auth
├── config
├── constants
├── errs
├── helper
├── iam
├── logger
├── profiler
├── router
├── security
└── types
</code></pre><h3 class="relative group">Using <code>go work</code> for Development<div id=using-go-work-for-development class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-go-work-for-development aria-label=Anchor>#</a></span></h3><p>Our individual projects—<code>server</code>, <code>client</code>, and <code>cli</code>—all have their own <code>go.mod</code>—but we don&rsquo;t use a common <code>go.mod</code> at the repo root, and we also do not release each project individually. This is perhaps adding needless complexity, and something to revise later. Regardless, we needed a way for projects to import from each other.</p><p>The legacy approach was to use <code>replace</code> inside each <code>go.mod</code> file, like so:</p><pre tabindex=0><code>module github.com/IllumiKnowLabs/labstore/cli

go 1.25.5

require (
    github.com/IllumiKnowLabs/labstore/server v0.0.0
)

replace github.com/IllumiKnowLabs/labstore/server =&gt; ../server
</code></pre><p>However, there is a cleaner, more modern approach, using <code>go.work</code>. In the repo root, run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go work init ./server ./client ./cli
</span></span><span class=line><span class=cl>go work sync
</span></span></code></pre></div><p>If you need to add another project later, you can use something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go work use ./share/logging
</span></span><span class=line><span class=cl>go work sync
</span></span></code></pre></div><p>Running <code>go work sync</code> will produce a <code>go.work.sum</code>, ensuring that workspace dependencies are consistent across all projects. Both files can be committed to your repo to ensure reproducibility, as well as for CI workflows.</p><h3 class="relative group">Building and CI<div id=building-and-ci class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#building-and-ci aria-label=Anchor>#</a></span></h3><h4 class="relative group">Linting with Pre-Commit<div id=linting-with-pre-commit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#linting-with-pre-commit aria-label=Anchor>#</a></span></h4><p>Since we moved to a monorepo with cross-project dependencies, we also had to update our CI workflows, making sure that our GitHub Actions for linting and testing still worked as expected.</p><p>Since we now have three projects for linting, we updated our <code>.pre-commit-config.yaml</code> as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>repos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/golangci/golangci-lint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rev</span><span class=p>:</span><span class=w> </span><span class=l>v2.6.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hooks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint (server)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>files</span><span class=p>:</span><span class=w> </span><span class=l>^server/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>entry</span><span class=p>:</span><span class=w> </span><span class=l>bash -c &#39;golangci-lint run ./server/...&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>language</span><span class=p>:</span><span class=w> </span><span class=l>system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pass_filenames</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint (client)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>files</span><span class=p>:</span><span class=w> </span><span class=l>^client/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>entry</span><span class=p>:</span><span class=w> </span><span class=l>bash -c &#39;golangci-lint run ./client/...&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>language</span><span class=p>:</span><span class=w> </span><span class=l>system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pass_filenames</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint (cli)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>files</span><span class=p>:</span><span class=w> </span><span class=l>^cli/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>entry</span><span class=p>:</span><span class=w> </span><span class=l>bash -c &#39;golangci-lint run ./cli/...&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>language</span><span class=p>:</span><span class=w> </span><span class=l>system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pass_filenames</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p>We use three similar <code>golangci-lint</code> entries (one per project), where we dropped <code>types: [go]</code>, replacing it with <code>pass_filenames: false</code>, as we explicitly pass the file arguments to the linter. Here, we simply use the same prefixes as the ones defined for <code>go.work</code>. For example, <code>./server/...</code> will cover all Go files under the <code>server</code> project.</p><p>If we, instead, tried to use a single entry with <code>./...</code>, then we would get the following error:</p><pre tabindex=0><code>ERRO [linters_context] typechecking error: pattern ./...: directory prefix . does not contain modules listed in go.work or their selected dependencies
0 issues.
</code></pre><p>When using <code>go.work</code>, make sure that linting is done for each individual module directory.</p><h4 class="relative group">GitHub Actions<div id=github-actions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#github-actions aria-label=Anchor>#</a></span></h4><p>We defined two workflows, one for linting, where we call <code>pre-commit</code>, and another one for testing, where we call <code>go test -v</code> for each module.</p><p>Both <code>lint.yml</code> and <code>test.yml</code>, which exist under <code>.github/workflows</code>, call a common composite action defined under <code>.github/actions/setup</code>, which will setup <code>go</code> and <code>node</code>, and build the <code>web</code> project, copying <code>web/build</code> to <code>server/pkg/router/assets</code>, where it lives, to be embedded during <code>server</code> building.</p><p>This is how the <code>jobs</code> entry for <code>lint.yml</code> looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pre-commit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>./.github/actions/setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>golangci-lint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>golangci/golangci-lint-action@v9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>install-only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>run pre-commit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>pre-commit/action@v3.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>extra_args</span><span class=p>:</span><span class=w> </span>--<span class=l>all-files</span><span class=w>
</span></span></span></code></pre></div><p>We install <code>golangci-lint</code> without running it (<code>install-only: true</code>) and then we call <code>pre-commit</code> to run it. This way, we share the same linting code for CI and <code>git commit</code>.</p><p>This is how the <code>jobs</code> entry for <code>test.yml</code> looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>go-tests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>./.github/actions/setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>go test (server)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>go test -v ./server/...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>go test (client)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>go test -v ./client/...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>go test (cli)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>go test -v ./cli/...</span><span class=w>
</span></span></span></code></pre></div><p>In here, we have to make sure we reference the modules defined in <code>go.work</code>, so we wouldn&rsquo;t be able to run <code>go test -v ./...</code> from the repo root.</p><h4 class="relative group">Makefile<div id=makefile class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#makefile aria-label=Anchor>#</a></span></h4><p>Finally, we had to adapt our <code>Makefile</code> to make sure our <code>cli</code> project was the only Go project being built, and that it depended on <code>web</code>. We also had to sync the static site files built for <code>web</code> with the <code>assets</code> directory on our <code>server</code> module.</p><p>These are the relevant targets to achieve what we just described:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>$(BIN_DIR)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	mkdir -p <span class=k>$(</span>BIN_DIR<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>WEB_SRCS</span> <span class=o>:=</span> <span class=k>$(</span>shell find <span class=k>$(</span>WEB_SRC_DIRS<span class=k>)</span> -type f<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(WEB_BUILD_DIR)</span><span class=o>:</span> <span class=k>$(</span><span class=nv>WEB_SRCS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> <span class=k>$(</span>WEB_DIR<span class=k>)</span> <span class=o>&amp;&amp;</span> npm ci
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> <span class=k>$(</span>WEB_DIR<span class=k>)</span> <span class=o>&amp;&amp;</span> npm run build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ASSETS_SRCS</span> <span class=o>:=</span> <span class=k>$(</span>shell find <span class=k>$(</span>WEB_BUILD_DIR<span class=k>)</span> -type f<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(ASSETS_DIR)</span><span class=o>:</span> <span class=k>$(</span><span class=nv>ASSETS_SRCS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	rsync -a --delete web/build/ <span class=k>$(</span>ASSETS_DIR<span class=k>)</span>/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>CLI_SRCS</span> <span class=o>=</span> <span class=k>$(</span>shell find <span class=k>$(</span>CLI_DIR<span class=k>)</span> <span class=k>$(</span>SERVER_DIR<span class=k>)</span> <span class=k>$(</span>CLIENT_DIR<span class=k>)</span> -name <span class=s1>&#39;*.go&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(CLI_CMD)</span><span class=o>:</span> <span class=k>$(</span><span class=nv>CLI_SRCS</span><span class=k>)</span> <span class=p>|</span> <span class=k>$(</span><span class=nv>BIN_DIR</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> <span class=k>$(</span>CLI_DIR<span class=k>)</span> <span class=o>&amp;&amp;</span> go build -o ../<span class=k>$(</span>CLI_CMD<span class=k>)</span> ./cmd/labstore
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>assets</span><span class=o>:</span> <span class=n>web</span> <span class=k>$(</span><span class=nv>ASSETS_DIR</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>cli</span><span class=o>:</span> <span class=n>assets</span> <span class=k>$(</span><span class=nv>CLI_CMD</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>web</span><span class=o>:</span> <span class=k>$(</span><span class=nv>WEB_BUILD_DIR</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>build</span><span class=o>:</span> <span class=n>cli</span>
</span></span></code></pre></div><p>Running <code>make</code> will result in the targets <code>web</code>, <code>assets</code>, and <code>cli</code> being run, building the node project, rsyncing the output to the <code>assets</code> directory under <code>server</code>, and building <code>cli/cmd/labstore</code> .</p><h2 class="relative group">Using Cobra to Produce Commands<div id=using-cobra-to-produce-commands class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-cobra-to-produce-commands aria-label=Anchor>#</a></span></h2><p>The entry point for the <a href=https://github.com/spf13/cobra target=_blank>Cobra</a> library is a root command. Commands can receive a context, and handle a return <code>error</code>. We take advantage of both options. This how our <code>main</code> package looks like under <code>cli/cmd/labstore</code>.</p><p>First, we enable the option to run all persistent pre-run and post-run from parents, as opposed to simply overriding them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cobra</span><span class=p>.</span><span class=nx>EnableTraverseRunHooks</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This means that anything defined on a persistent pre-run will always be run downstream.</p><p>Then, we create a root command using our own <code>NewRootCmd()</code>, and pass it a context that captures interrupt signals. This will help us control user interruptions, i.e., <code>ctrl+c</code> or <code>SIGINT</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span> <span class=o>:=</span> <span class=nf>NewRootCmd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>stop</span> <span class=o>:=</span> <span class=nx>signal</span><span class=p>.</span><span class=nf>NotifyContext</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>ExecuteContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We handle errors manually, so we set the following options for the root command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceErrors</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceUsage</span> <span class=p>=</span> <span class=kc>true</span>
</span></span></code></pre></div><p>We then detect <code>errs.RuntimeError</code>, which we use to signal that an error has already been handled upstream, and only print the error and usage for any other errors (default behavior):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>ExecuteContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>runtimeError</span> <span class=o>*</span><span class=nx>errs</span><span class=p>.</span><span class=nx>RuntimeError</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>As</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>runtimeError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>cmdErr</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>cmdErr</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>cmd</span><span class=p>.</span><span class=nf>PrintErrln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>helper</span><span class=p>.</span><span class=nf>CheckFatal</span><span class=p>(</span><span class=nx>cmd</span><span class=p>.</span><span class=nf>Usage</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">Root Command<div id=root-command class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#root-command aria-label=Anchor>#</a></span></h3><p>Our root command is defined in the <code>NewRootCmd()</code> constructor. First, we create a <code>*cobra.Command</code> instance:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>constants</span><span class=p>.</span><span class=nx>Name</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s, by %s&#34;</span><span class=p>,</span> <span class=nx>constants</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>constants</span><span class=p>.</span><span class=nx>Author</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s - %s, by %s&#34;</span><span class=p>,</span> <span class=nx>constants</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>constants</span><span class=p>.</span><span class=nx>Description</span><span class=p>,</span> <span class=nx>constants</span><span class=p>.</span><span class=nx>Author</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>PersistentPreRun</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>baseCmd</span> <span class=o>:=</span> <span class=nf>topLevelCommand</span><span class=p>(</span><span class=nx>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>baseCmd</span><span class=p>.</span><span class=nf>Name</span><span class=p>()</span> <span class=o>==</span> <span class=s>&#34;completion&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;show-default-secret&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;yes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>config</span><span class=p>.</span><span class=nx>DisplayDefaultAdminSecretKey</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;mode&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;daemon&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>slog</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=nx>slog</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nx>slog</span><span class=p>.</span><span class=nf>NewTextHandler</span><span class=p>(</span><span class=nx>io</span><span class=p>.</span><span class=nx>Discard</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>			<span class=nx>config</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>bootstrap</span><span class=p>(</span><span class=nx>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here, <code>Use</code> will represent the command name (<code>labstore</code> for the root command, same as the binary name).</p><h3 class="relative group">Positional Arguments<div id=positional-arguments class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#positional-arguments aria-label=Anchor>#</a></span></h3><p>For subcommands, <code>Use</code> can also contain the expected positional arguments, e.g. <code>labstore iam users create</code> requires a <code>USERNAME</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewUsersCreateCmd</span><span class=p>()</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>cmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;create USERNAME&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Create an IAM user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Args</span><span class=p>:</span>  <span class=nx>cobra</span><span class=p>.</span><span class=nf>MinimumNArgs</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>RunE</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Value</span><span class=p>(</span><span class=nx>handlerKeyCtx</span><span class=p>).(</span><span class=o>*</span><span class=nx>handlers</span><span class=p>.</span><span class=nx>IAMHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>handler</span><span class=p>.</span><span class=nf>CreateUser</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cmd</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Notice that <code>Args</code> is set to <code>cobra.MinimumNArgs(1)</code>, to ensure <code>USERNAME</code> will be set.</p><p>We also set a <code>Short</code> description, displayed when listing commands, and we can set an optional <code>Long</code> description, if we want to display further details when showing the help for that specific command.</p><h3 class="relative group">Run Hooks<div id=run-hooks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#run-hooks aria-label=Anchor>#</a></span></h3><p>Then, we can make use of several run methods:</p><ul><li><code>PersistentPreRun</code> / <code>PersistentPreRunE</code></li><li><code>PreRun</code> / <code>PreRunE</code></li><li><code>Run</code> / <code>RunE</code></li><li><code>PostRun</code> / <code>PostRunE</code></li><li><code>PersistentPostRun</code> / <code>PersistentPostRunE</code></li></ul><p>For the persistent variants, depending on whether <code>cobra.EnableTraverseRunHooks</code> is <code>true</code> or <code>false</code>, we&rsquo;ll get different behaviors. For <code>true</code>, persistent hooks will trigger in-order from outer to inner level (pre) or from inner to outer level (post). For <code>false</code>, the inner-most definition will take precedence, in overridable fashion.</p><p>For the <code>E</code> suffix variants, our function must return <code>error</code>. This is automatically handled by Cobra, although, like we stated above, we disabled this default behavior and handled it ourselves.</p><h3 class="relative group">Annotations<div id=annotations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#annotations aria-label=Anchor>#</a></span></h3><p>We can also find a few annotation checks. Each command can store a <code>map[string]string</code> containing app-specific metadata to help handle the flow. For example, our <code>serve</code> command is configured as follows, with the <code>show-default-secret</code> annotation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>&#34;Run server for S3, IAM, and admin services&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>adminPass</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Lookup</span><span class=p>(</span><span class=s>&#34;admin-pass&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>adminPass</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>adminPass</span><span class=p>.</span><span class=nx>Changed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>slog</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;setting admin pass via the command line is insecure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>router</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;show-default-secret&#34;</span><span class=p>:</span> <span class=s>&#34;yes&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This annotation is then handled on our root command, determining whether to display a default admin secret key, when it hasn&rsquo;t been specified by the user elsewhere on the config (this will be handled internally by the <code>config</code> package):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;show-default-secret&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;yes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>DisplayDefaultAdminSecretKey</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">Flags and Subcommands<div id=flags-and-subcommands class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#flags-and-subcommands aria-label=Anchor>#</a></span></h3><p>Once the <code>cmd</code> is instanced in the <code>NewRootCmd()</code> constructor, then we can add flags or persistent flags (i.e., common to all subcommands), as well as the subcommands, each having a similar constructor:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceErrors</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceUsage</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>PersistentFlags</span><span class=p>().</span><span class=nf>Bool</span><span class=p>(</span><span class=s>&#34;debug&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Set debug level for logging&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>PersistentFlags</span><span class=p>().</span><span class=nf>Bool</span><span class=p>(</span><span class=s>&#34;pprof&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Enable profiler&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>PersistentFlags</span><span class=p>().</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;pprof-host&#34;</span><span class=p>,</span> <span class=s>&#34;localhost&#34;</span><span class=p>,</span> <span class=s>&#34;Profiler host&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>PersistentFlags</span><span class=p>().</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;pprof-port&#34;</span><span class=p>,</span> <span class=mi>6060</span><span class=p>,</span> <span class=s>&#34;Profiler port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nf>NewServeCmd</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nf>NewS3Cmd</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nf>NewIAMCmd</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nf>NewAdminCmd</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nf>NewTUICmd</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nf>AddDaemonCommands</span><span class=p>(</span><span class=nx>cmd</span><span class=p>)</span>
</span></span></code></pre></div><h3 class="relative group">Help Message<div id=help-message class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#help-message aria-label=Anchor>#</a></span></h3><p>This is what running the <code>labstore</code> command without any options will print:</p><pre tabindex=0><code>LabStore - An S3-Compatible Object Store, by IllumiKnow Labs

Usage:
  labstore [command]

Available Commands:
  admin       Admin client
  completion  Generate the autocompletion script for the specified shell
  help        Help about any command
  iam         IAM client, designed for learning
  restart     Restart LabStore server
  s3          S3 client, designed for learning
  serve       Run server
  start       Start LabStore server
  status      Check if LabStore server is running
  stop        Stop LabStore server
  tui         TUI and helper commands

Flags:
      --debug               Set debug level for logging
  -h, --help                help for labstore
      --pprof               Enable profiler
      --pprof-host string   Profiler host (default &#34;localhost&#34;)
      --pprof-port int      Profiler port (default 6060)

Use &#34;labstore [command] --help&#34; for more information about a command.
</code></pre><p>Here&rsquo;s a semantically organized listing of the supported commands as well—something that would be nice do in Cobra as well, without having to create subcommands, for improved readability, like <code>just</code> does with groups:</p><ul><li><strong>Server</strong><ul><li><code>server</code> – used to start the services for the LabStore server (admin, S3, IAM, and web UI).</li></ul></li><li><strong>Clients</strong><ul><li><code>admin</code> – admin service client (does nothing at this time).</li><li><code>iam</code> – IAM client designed for learning, not usability (maps one-to-one to the IAM service implementation).</li><li><code>s3</code> – S3 client designed for learning, not usability (maps one-to-one to the S3 service implementation).</li></ul></li><li><strong>Daemon</strong> – convenience commands for a better UX when testing LabStore, so you can manage the server without having to deploy our Docker container, or setup your own systemd service.<ul><li><code>start</code></li><li><code>stop</code></li><li><code>restart</code></li><li><code>status</code></li></ul></li><li><strong>Helpers</strong><ul><li><code>tui palette</code> – as of now, it displays the color scheme for our palette and, in the future, its parent command will be the home for our TUI as well.</li><li><code>completion</code> – automatic shell completion scripts provided by Cobra (supports bash, zsh, fish, and PowerShell).</li><li><code>help</code> – go-style help and usage messages.</li></ul></li></ul><h3 class="relative group">Shell Autocompletion<div id=shell-autocompletion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#shell-autocompletion aria-label=Anchor>#</a></span></h3><p>As shown in the help, in the future, after you <code>go install</code> LabStore, you&rsquo;ll also be able to setup autocompletion for your shell. For example, for fish, you just add this to your <code>~/.config/fish/config.fish</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nf>labstore</span> completion <span class=nb>fish</span> <span class=o>|</span> <span class=nb>source</span> <span class=na>-
</span></span></span></code></pre></div><p>With <code>cobra</code>, you get autocompletion for your CLI, out-of-the-box, at a zero-cost.</p><h2 class="relative group">Managing Multiple HTTP Services<div id=managing-multiple-http-services class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#managing-multiple-http-services aria-label=Anchor>#</a></span></h2><p>When we run <code>labstore serve</code>, we start multiple <code>http.Server</code> instances concurrently using goroutines. In order to manage this, we define the following type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ServerDescriptor</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Server</span>  <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl>	<span class=nx>Healthy</span> <span class=nx>atomic</span><span class=p>.</span><span class=nx>Bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>Name</code> (e.g., S3-Compatible API, or IAM) will be used to display a message letting the user know where to connect for each service:</p><pre tabindex=0><code>🌐 S3-Compatible API listening on http://0.0.0.0:6789
🌐 IAM listening on http://0.0.0.0:6788
🌐 Web UI listening on http://0.0.0.0:6790
🌐 Admin API listening on http://0.0.0.0:6787
</code></pre><p>The URL will be extracted from <code>Server.Addr</code>. Once the server is started, its <code>Healthy</code> status will be set to <code>true</code>. This will be monitored by our admin service, which will return <code>HTTP 200 (OK)</code> when all services are healthy, or <code>HTTP 503 (Service Unavailable)</code> when any of the S3, IAM, or Web UI services are down.</p><p>We instance each service using values from config, e.g.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>webServerDescriptor</span> <span class=o>:=</span> <span class=nf>NewWebServerDescriptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Web</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nx>Host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Web</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>We then handle the lifecycle under <code>router.Start()</code> as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>wg</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl><span class=nx>errCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>serverDescriptors</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>sd</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>serverDescriptors</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nf>runServer</span><span class=p>(</span><span class=nx>sd</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>wg</span><span class=p>,</span> <span class=nx>errCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sd</span><span class=p>.</span><span class=nx>Healthy</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>go</span> <span class=nf>shutdownServers</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>serverDescriptors</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>go</span> <span class=nf>waitAndClose</span><span class=p>(</span><span class=nx>errCh</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>wg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>err</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errCh</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>slog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;server error&#34;</span><span class=p>,</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>slog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;all servers shut down cleanly&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>We monitor the error channel <code>errCh</code>, shared among all services. Each service is started in a goroutine using <code>go runServer(...)</code> and setting its healthy status to <code>true</code>—if an error occurs or it terminates, it will be set to <code>false</code>. Errors are sent to <code>errCh</code>, which also blocks the flow until completion:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>err</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errCh</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>slog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;server error&#34;</span><span class=p>,</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>shutdownServers</code> goroutine will immediately block until the context is done:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>shutdownServers</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>serverDescriptors</span> <span class=p>[]</span><span class=o>*</span><span class=nx>ServerDescriptor</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>slog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;shutdown signal received&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>shutdownCtx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>serverDescriptors</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=o>:=</span> <span class=nx>serverDescriptors</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=nx>slog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;shutting down server&#34;</span><span class=p>,</span> <span class=s>&#34;addr&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Server</span><span class=p>.</span><span class=nx>Addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Server</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>shutdownCtx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And the context is instanced in <code>router.Start()</code>, as follows, to listen for <code>SIGINT</code> or <code>SIGTERM</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ctx</span><span class=p>,</span> <span class=nx>stop</span> <span class=o>:=</span> <span class=nx>signal</span><span class=p>.</span><span class=nf>NotifyContext</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nf>stop</span><span class=p>()</span>
</span></span></code></pre></div><p>Again, notice that <code>runServer</code>, <code>shutdownServers</code>, and <code>waitAndClose</code> are all started concurrently, but <code>shutdownServers</code> will immediately block due to <code>&lt;- ctx.Done()</code>, which only resumes on interruption (<code>SIGINT</code> or <code>SIGTERM</code>). This is how simple and powerful channels are in Go!</p><p>Once each server is shutdown, <code>runServer</code> will return and call <code>wg.Done()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>runServer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>sd</span> <span class=o>*</span><span class=nx>ServerDescriptor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>errCh</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=kt>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;🌐 %s listening on http://%s\n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>sd</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>sd</span><span class=p>.</span><span class=nx>Server</span><span class=p>.</span><span class=nx>Addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>sd</span><span class=p>.</span><span class=nx>Server</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sd</span><span class=p>.</span><span class=nx>Healthy</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>errCh</span> <span class=o>&lt;-</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Finally, we wait for all goroutines to be done, and close <code>errCh</code> to exit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>waitAndClose</span><span class=p>(</span><span class=nx>errCh</span> <span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=nx>wg</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nb>close</span><span class=p>(</span><span class=nx>errCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Server errors are printed as they arrive, but the whole program is blocked until the <code>errCh</code> is closed, at which time it prints a log message:</p><pre tabindex=0><code>Jan 23 17:09:46.263 INF all servers shut down cleanly
</code></pre><h2 class="relative group">Managing Client-Side Credentials<div id=managing-client-side-credentials class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#managing-client-side-credentials aria-label=Anchor>#</a></span></h2><p>Since we&rsquo;re implementing an S3 client, we&rsquo;ll need a way to manage client-side credentials. This is usually done using some kind of config file. As we know, the <code>aws</code> CLI tool uses the concept of profile. We adopted a lightweight approach of this same idea.</p><p>We questioned whether we should:</p><ol><li>Extend our config file format to include client configs (i.e., a top-level <code>client</code> entry), with overrides via CLI args and env vars.</li><li>Same as previous, with a config file, but without overrides.</li><li>Create a simpler YAML file for credentials.</li></ol><p>We ended up going with option 3, creating a <code>~/.config/labstore/credentials.yml</code>, automatically initialized when not found, and based on profiles. Something like this, but empty by default:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default_profile</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>profiles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>access_key</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret_key</span><span class=p>:</span><span class=w> </span><span class=l>adminadmin</span><span class=w>
</span></span></span></code></pre></div><p>After editing this file, the user can then call authenticated commands without specifying a profile, in which case the profile set in <code>default_profile</code> will be used, unless overridden by <code>--profile</code>. Since credentials are prone to fail due to server or client side config issues, we decided that having a single source of truth would reduce any potential debugging there.</p><h2 class="relative group">First Look at TUI Design<div id=first-look-at-tui-design class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#first-look-at-tui-design aria-label=Anchor>#</a></span></h2><p>Our next release will focus on the TUI, but, for the CLI, we already used a few TUI tricks based on <a href=https://github.com/charmbracelet/lipgloss target=_blank>lipgloss</a> and <a href=https://github.com/charmbracelet/bubbletea target=_blank>bubbletea</a>, from the <a href=https://charm.land/libs/ target=_blank>charm stack</a>.</p><p>We used <code>lipgloss</code> to create CLI styles—color scheme, width, alignment, margin, padding,setting bold, etc.— and we used <code>bubbletea</code> for its progress bar component, that we needed to track uploads (<code>PutObject</code>) and downloads (<code>GetObject</code>).</p><h3 class="relative group">Color Palette<div id=color-palette class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#color-palette aria-label=Anchor>#</a></span></h3><p>Our color palette was defined using a custom type containing multiple <code>lipgloss.Color</code> entries:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Palette</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>TextPrimary</span>  <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>TextMuted</span>    <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>TextInverted</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Surface</span>      <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>SurfaceAlt</span>   <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>SurfaceHover</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Accent</span>      <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>AccentMuted</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Success</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>Warning</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>	<span class=nx>Error</span>   <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Border</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Color</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The actual final color will depend on the terminal you&rsquo;re using, and whether it supports 16-colors, 256-colors, or true color, but <code>lipgloss</code> will handle the fallback for you transparently—it might not look good, if you don&rsquo;t test it thoroughly, but it will work.</p><p>We then define two variables of type <code>Palette</code>, named <code>DefaultPalette</code> and <code>ActivePalette</code>. At this time, both variables are the same, but, in the future, we can easily extend this to support external color scheme loading (e.g., load an external file format to override <code>DefaultPalette</code> entries).</p><h3 class="relative group">Styling<div id=styling class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#styling aria-label=Anchor>#</a></span></h3><p>A common styling strategy with <code>lipgloss</code> is to instance <code>lipgloss.NewStyle()</code> and, using method chaining to set all the required display properties. It looks something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>metaLabelStyle</span> <span class=o>:=</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nf>NewStyle</span><span class=p>().</span>
</span></span><span class=line><span class=cl>	<span class=nf>Width</span><span class=p>(</span><span class=mi>20</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>Bold</span><span class=p>(</span><span class=kc>true</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>Align</span><span class=p>(</span><span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Right</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>PaddingRight</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>MarginRight</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>Background</span><span class=p>(</span><span class=nx>ActivePalette</span><span class=p>.</span><span class=nx>Surface</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>Foreground</span><span class=p>(</span><span class=nx>ActivePalette</span><span class=p>.</span><span class=nx>TextPrimary</span><span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nx>Render</span>
</span></span></code></pre></div><p>If you&rsquo;re defining the final style, you can simply return <code>Render</code>, like we do, which is the method you call to render a string with the given display options. A few examples in the <code>lipgloss</code> repo use this same strategy, so we generically adopted it. Notice that padding and margin is defined as multiples or columns or lines—if you&rsquo;re coming from web design, remember that designing for a TUI is more limited due to the constraints of the display support—the terminal, rather than the browser.</p><h3 class="relative group">Generics and Type Constraints in Go<div id=generics-and-type-constraints-in-go class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#generics-and-type-constraints-in-go aria-label=Anchor>#</a></span></h3><p>In Go, we often do not need generics (or at least I haven&rsquo;t), so it&rsquo;s worth mentioning a use case where generics were helpful. Since we often had to display metadata (i.e., key-value style information), we ended up creating a custom <code>Metadata</code> type, with its own <code>Render</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Metadata</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Meta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Meta</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Value</span>  <span class=nx>any</span>
</span></span><span class=line><span class=cl>	<span class=nx>Format</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We wanted to be able to customize the display of generic strings and numbers, as well as dates (<code>time.Time</code>) and sizes (<code>int64</code>). In particular for numbers, we wanted to accept any of the supported types in Go, which also meant distinguishing from sizes.</p><p>We approached this by using generics and the following type constraint:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Number</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>~</span><span class=kt>float32</span> <span class=p>|</span> <span class=p>~</span><span class=kt>float64</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>		<span class=p>~</span><span class=kt>int</span> <span class=p>|</span> <span class=p>~</span><span class=kt>int8</span> <span class=p>|</span> <span class=p>~</span><span class=kt>int16</span> <span class=p>|</span> <span class=p>~</span><span class=kt>int32</span> <span class=p>|</span> <span class=p>~</span><span class=kt>int64</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>		<span class=p>~</span><span class=kt>uint</span> <span class=p>|</span> <span class=p>~</span><span class=kt>uint8</span> <span class=p>|</span> <span class=p>~</span><span class=kt>uint16</span> <span class=p>|</span> <span class=p>~</span><span class=kt>uint32</span> <span class=p>|</span> <span class=p>~</span><span class=kt>uint64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Such an interface can only be used with generics to limit the acceptable types. The tilde means that any type with the same underlying type will match (e.g., based on <code>~int64</code>, it would accept <code>type MyInt int64</code>).</p><p>Then we defined a constructor per type. For example, we defined <code>NewNumber</code> as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nx>NewNumber</span><span class=p>[</span><span class=nx>T</span> <span class=nx>Number</span><span class=p>](</span><span class=nx>value</span> <span class=nx>T</span><span class=p>)</span> <span class=nx>Meta</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>Meta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Format</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>p</span> <span class=o>:=</span> <span class=nx>message</span><span class=p>.</span><span class=nf>NewPrinter</span><span class=p>(</span><span class=nx>language</span><span class=p>.</span><span class=nx>English</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=nx>val</span> <span class=o>:=</span> <span class=nf>any</span><span class=p>(</span><span class=nx>value</span><span class=p>).(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=kt>float32</span><span class=p>,</span> <span class=kt>float64</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%.6f&#34;</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div><p>This will format numbers with thousands commas, with floats having 6-decimals—anything else will be an integer.</p><p>In <code>Metadata.Render</code> we define the styles to use and then iterate over the keys in the map, after sorting them (<code>labels</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>labels</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metaRow</span> <span class=o>:=</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nf>JoinHorizontal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Top</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nf>metaLabelStyle</span><span class=p>(</span><span class=nx>label</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nf>MetaValueStyle</span><span class=p>(</span><span class=nx>metadata</span><span class=p>[</span><span class=nx>label</span><span class=p>].</span><span class=nf>Format</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rows</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rows</span><span class=p>,</span> <span class=nx>metaRow</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>metaView</span> <span class=o>:=</span> <span class=nx>lipgloss</span><span class=p>.</span><span class=nf>JoinVertical</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lipgloss</span><span class=p>.</span><span class=nx>Left</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>rows</span><span class=o>...</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>metaView</span> <span class=o>+</span> <span class=s>&#34;\n&#34;</span>
</span></span></code></pre></div><p>As you can see, <code>lipgloss</code> provides a <code>JoinHorizontal</code>, as well as a <code>JoinVertical</code>, that can be quite useful in designing our TUI.</p><p>This will render to something like this:</p><p><figure><img class="my-0 rounded-md" loading=lazy src=./labstore-metadata-rendering.png alt="LabStore Metadata Rendering Example"></figure></p><h3 class="relative group">Designing a Progress Bar Component<div id=designing-a-progress-bar-component class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#designing-a-progress-bar-component aria-label=Anchor>#</a></span></h3><p>We also implemented a progress bar, in order to track uploads (<code>PutObject</code>) and downloads (<code>GetObject</code>). This was based on the <a href=https://github.com/charmbracelet/bubbletea/tree/f9233d51192293dadda7184a4de347738606c328/examples/progress-animated target=_blank>progress-animated</a> example straight from the <code>bubbletea</code> repo, with an optional console output component, to divert the logger to, while <code>bubbletea</code> takes over the CLI.</p><p><figure><img class="my-0 rounded-md" loading=lazy src=./labstore-progress-bar.png alt="LabStore Progress Bar"></figure></p><p>Since we do not have an actual TUI, and we do not relinquish control to <code>bubbletea</code> completely (i.e., the main program loop is not exclusively running a <code>tea.Program</code>), we needed to take extra care in designing our architecture.</p><p>In order to display a <code>bubbletea</code> component, we must first define a type that implements the <code>tea.Model</code> interface, providing <code>Init()</code>, <code>Update()</code>, and <code>View()</code> methods.</p><p>This is how our progress bar model looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ProgressBarModel</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Ctx</span>            <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span>
</span></span><span class=line><span class=cl>	<span class=nx>Bar</span>            <span class=nx>progress</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>	<span class=nx>MaxConsoleSize</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>Debug</span>          <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Progress</span> <span class=kd>chan</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Progress</span>
</span></span><span class=line><span class=cl>	<span class=nx>Message</span>  <span class=kd>chan</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>done</span>     <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cancel</span>  <span class=nx>context</span><span class=p>.</span><span class=nx>CancelFunc</span>
</span></span><span class=line><span class=cl>	<span class=nx>program</span> <span class=o>*</span><span class=nx>tea</span><span class=p>.</span><span class=nx>Program</span>
</span></span><span class=line><span class=cl>	<span class=nx>width</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>height</span>  <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span> <span class=p>[]</span><span class=kt>string</span>
</span></span></code></pre></div><p>In Go, as a rule of thumb, always pass the context. Everything, from Cobra to the standard HTTP library, uses a context. Simply passing the context will make it easier to receive interruption or cancellation signals. This is our <code>Ctx</code>.</p><p>We define a <code>Bar</code> that uses the <code>bubbles</code> <code>progress.Model</code> component.</p><p>We define <code>MaxConsoleSize</code> to determine the maximum number of lines to display at once for our console output—if we hadn&rsquo;t limited this, the program would progressively slow down, as it had to keep in memory the whole console output and update it every time it called <code>View()</code>.</p><p>Then we pass <code>Debug</code>, based on the <code>--debug</code> flag from the CLI.</p><p>On the next segment, we define channels—<code>Progress</code> will serve to update the current value in the progress bar, while <code>Message</code> will write a message to the console component; <code>done</code> just signals that the progress bar terminated.</p><p>The remaining variables are helpers—<code>cancel</code> ensures the context is cancellable, <code>program</code> runs the TUI component, <code>width</code> and <code>height</code> track current terminal dimensions, and <code>console</code> keeps the last <code>MaxConsoleSize</code> messages being displayed.</p><p>The two most relevant methods in our progress bar are <code>Update()</code> and <code>Run()</code>—this last one replaces the usual TUI starter on <code>main()</code>. The <code>Init()</code> method only calls <code>Bar.Init()</code>, while the <code>View()</code> method is just regular <code>lipgloss</code> styling, like we&rsquo;ve seen in the previous sections.</p><h4 class="relative group">Processing Update Events<div id=processing-update-events class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#processing-update-events aria-label=Anchor>#</a></span></h4><p>The <code>Update()</code> method looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>ProgressBarModel</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>msg</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>Msg</span><span class=p>)</span> <span class=p>(</span><span class=nx>tea</span><span class=p>.</span><span class=nx>Model</span><span class=p>,</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>Cmd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>msg</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>SomeEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// handle and produce a tea.Cmd
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>cmd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is our event loop, where we process each event (e.g., <code>SomeEvent</code>, which is not real), and return the model and a <code>tea.Cmd</code> to execute.</p><p>Let&rsquo;s go through each event. First, let&rsquo;s take a look at how we handle updating the progress bar&rsquo;s current value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>progressMsg</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>current</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>total</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>case</span> <span class=nx>progressMsg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=nx>pct</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>current</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>total</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pct</span> <span class=o>&gt;=</span> <span class=mf>1.0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Bar</span><span class=p>.</span><span class=nf>SetPercent</span><span class=p>(</span><span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>tea</span><span class=p>.</span><span class=nf>Sequence</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>Quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Bar</span><span class=p>.</span><span class=nf>SetPercent</span><span class=p>(</span><span class=nx>pct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>cmd</span>
</span></span></code></pre></div><p>This receives the current and total values as integers, and computes the percentage to set the progress bar to. If we reach 100%, then we trigger <code>tea.Quit</code>, as a part of a <code>tea.Sequence</code> of commands, where the first command sets the percentage to 100% before quitting. Otherwise, we just set the percentage.</p><p>Secondly, we handle our console messages:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>consoleMsg</span> <span class=kt>string</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>case</span> <span class=nx>consoleMsg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nx>console</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>console</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>console</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>m</span><span class=p>.</span><span class=nx>MaxConsoleSize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>m</span><span class=p>.</span><span class=nx>console</span> <span class=p>=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>console</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>console</span><span class=p>)</span><span class=o>-</span><span class=nx>m</span><span class=p>.</span><span class=nx>MaxConsoleSize</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=kc>nil</span>
</span></span></code></pre></div><p>This is essentially a circular or ring buffer—we delete older messages as we hit the limit set by <code>MaxConsoleSize</code>.</p><p>Finally, we handle <code>bubbletea</code> and <code>bubble</code> specific events:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>case</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>KeyMsg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>KeyCtrlC</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;SIGINT caught, quitting...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>Quit</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nx>progress</span><span class=p>.</span><span class=nx>FrameMsg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=nx>progressModel</span><span class=p>,</span> <span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Bar</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nx>Bar</span> <span class=p>=</span> <span class=nx>progressModel</span><span class=p>.(</span><span class=nx>progress</span><span class=p>.</span><span class=nx>Model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>cmd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nx>tea</span><span class=p>.</span><span class=nx>WindowSizeMsg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span> <span class=nx>m</span><span class=p>.</span><span class=nx>height</span> <span class=p>=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Width</span><span class=p>,</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Height</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nx>Bar</span><span class=p>.</span><span class=nx>Width</span> <span class=p>=</span> <span class=nb>min</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Width</span><span class=p>,</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=kc>nil</span>
</span></span></code></pre></div><p>Here, <code>tea.KeyMsg</code> handles key presses—we capture <code>ctrl+c</code> and exit. Then, <code>progress.FrameMsg</code> will handle the animation, triggering at a given frame rate, as opposed to instantly updating, and <code>tea.WindowSizeMsg</code> signals terminal size changes, so we can handle it properly.</p><h4 class="relative group">Running and Consuming Channels<div id=running-and-consuming-channels class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#running-and-consuming-channels aria-label=Anchor>#</a></span></h4><p>Running our program means starting the <code>tea.Program</code> by calling <code>program.Run()</code>, but also handling channel consumption and program message sending, as well as context cancelling.</p><p>The overall structure of <code>Run()</code> looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>ProgressBarModel</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>done</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>wg</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>output</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>consoleWriter</span><span class=p>{</span><span class=nx>ctx</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>,</span> <span class=nx>ch</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Message</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>revert</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Swap</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>WithDebugFlag</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Debug</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// consume Progress channel
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// consume Message channel
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>program</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>revert</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>slog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;progress bar&#34;</span><span class=p>,</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>slog</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;progress bar done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see, we defer the closing of the <code>done</code> channel, so that it is called when the function returns and unblocks any termination routine (like we did for the multiple HTTP services, described in a <a href=#managing-multiple-http-services>previous section</a>). We also define a wait group with two tasks, one for each channel consumer (defined in the <code>go func()</code> calls).</p><p>Let&rsquo;s take note of the <code>logger.Swap</code> logic:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>output</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>consoleWriter</span><span class=p>{</span><span class=nx>ctx</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>,</span> <span class=nx>ch</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Message</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>revert</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Swap</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>WithDebugFlag</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Debug</span><span class=p>))</span>
</span></span></code></pre></div><p>Our <code>logger.Swap</code> method is simple. It will create a new logger, with the given output, and set it as the default, while saving the previous logger, that can be restored by calling <code>revert()</code>. What we&rsquo;re doing here is diverting the logger into a <code>consoleWriter</code>, which takes a channel—the <code>Message</code> channel is used—and writes messages to that channel instead of <code>stdout</code> or <code>stderr</code>. This is how we produce the console messages you&rsquo;ve seen us handle in the <code>Update()</code> method above.</p><p>We then start a consumer in a goroutine for the <code>Progress</code> and <code>Message</code> channels, and we run the program. Once the program exits, we cancel the context, we wait for each consumer to finish, and we revert the logger.</p><p>Channel consumers look similar, but, for the <code>Progress</code> channel, we ensure we consume all remaining messages before releasing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>m</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Consume remaining
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>m</span><span class=p>.</span><span class=nx>Progress</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>m</span><span class=p>.</span><span class=nx>program</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>progressMsg</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>current</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Current</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>total</span><span class=p>:</span>   <span class=nx>msg</span><span class=p>.</span><span class=nx>Total</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>m</span><span class=p>.</span><span class=nx>Progress</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>m</span><span class=p>.</span><span class=nx>program</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>progressMsg</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>current</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Current</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>total</span><span class=p>:</span>   <span class=nx>msg</span><span class=p>.</span><span class=nx>Total</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span></code></pre></div><p>As you can see, we have an infinite <code>for</code> loop, where we call <code>select</code>. This is a reserved keyword used to randomly poll channels and handle the first that isn&rsquo;t blocked—<code>default</code> will be triggered when all channels are blocked.</p><p>We separate two cases:</p><ol><li>Either the context is done, and we must finish up;</li><li>Or we&rsquo;re reading a <code>Progress</code> message.</li></ol><p>We&rsquo;ll block otherwise, as we do not have a <code>default</code> case.</p><p>When we receive a <code>Progress</code> message, we send <code>progressMsg</code> to our <code>program</code>, synchronously. When the context is done, we process all remaining <code>Progress</code> messages and then unblock and return with the <code>default</code> case. Once the goroutine returns, the wait group will signal that this task is done.</p><p>Due to the complexity of this workflow, we still have some issues where the progress bar terminates without updating completely, despite having reached 100%—use <code>--debug</code> if you need to confirm this is happening. It will be fixed in the future, perhaps for release <code>v0.2.0</code>! 😅</p><h2 class="relative group">One Binary to Rule Them All<div id=one-binary-to-rule-them-all class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#one-binary-to-rule-them-all aria-label=Anchor>#</a></span></h2><p>Finally, let&rsquo;s close with something interesting about Go programs.</p><p>We often install Go apps using <code>go install</code>, and surely you have noticed that there is no <code>go uninstall</code>. This is because <code>go install</code> will download, build, and install a single command, usually copying the binary to <code>~/go/bin</code>—which should be a part of your <code>PATH</code>. Uninstall can be done simply by deleting the binary, with <code>rm ~/go/bin/&lt;command></code>.</p><p>That said, in Go, we are able to embed files directly into our binary, which is perfect if we want to keep it in line with the installation approach I just described.</p><h3 class="relative group">Embedding and Serving the Web UI<div id=embedding-and-serving-the-web-ui class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#embedding-and-serving-the-web-ui aria-label=Anchor>#</a></span></h3><p>Our web UI is planned as a SvelteKit app, to be deployed as a static site. Our original approach to deploying this to production was to produce a <code>Dockerfile.web</code> that built the static site and deployed it using Nginx. But why do this when we can just embed the static site directly into our <code>server</code> library and serve it with <code>http.FileServer</code>? How hard can it be, right?</p><p>Well, as it turns out, it&rsquo;s not hard at all:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//go:embed assets/**
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>frontendFiles</span> <span class=nx>embed</span><span class=p>.</span><span class=nx>FS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewWebServerDescriptor</span><span class=p>(</span><span class=nx>host</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>port</span> <span class=kt>uint16</span><span class=p>)</span> <span class=o>*</span><span class=nx>ServerDescriptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>slog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;web ui server&#34;</span><span class=p>,</span> <span class=s>&#34;host&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>addr</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%d&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>contentFS</span> <span class=o>:=</span> <span class=nx>helper</span><span class=p>.</span><span class=nf>Must</span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>frontendFiles</span><span class=p>,</span> <span class=s>&#34;assets&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>httpFS</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FS</span><span class=p>(</span><span class=nx>contentFS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>httpFS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Addr</span><span class=p>:</span>    <span class=nx>addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Handler</span><span class=p>:</span> <span class=nx>handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>serverDescriptor</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ServerDescriptor</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Name</span><span class=p>:</span>   <span class=s>&#34;Web UI&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Server</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>server</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>serverDescriptor</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The previous code is from <code>server/pkg/router/web.go</code>. First, we need to make sure that the <code>web/build</code> directory is synced to <code>server/pkg/router/assets/</code>, which we have done using our <code>Makefile</code>, as described in a <a href=#makefile>previous section</a>, although this will have to change in the future, if we want to use <code>go install</code>.</p><p>Then, we simply define a variable with a special <code>go:embed</code> comment pointing to the <code>assets</code> directory. This comment is the magic sauce:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//go:embed assets/**
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>frontendFiles</span> <span class=nx>embed</span><span class=p>.</span><span class=nx>FS</span>
</span></span></code></pre></div><p>Once set, we can access our files using <code>fs.Sub</code>, which returns an <code>fs.FS</code> instance, and serve them using <code>http.FS</code>, which returns an <code>http.FileSystem</code> instance. We pass this to an <code>http.FileServer</code>, which provides an HTTP handler that we can serve as usual.</p><p>That&rsquo;s it! Pretty sweet, right?</p><p>We end up with a single 21 MiB binary that has it all—one binary to rule them all! 😎</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>❯ du -h bin/labstore
</span></span><span class=line><span class=cl>21M     bin/labstore
</span></span></code></pre></div><p>This binary provides the S3 and IAM server, the web UI server (no Nginx required), and the clients for S3 and IAM. And, next time, it will also provide the TUI for S3 and IAM! 🚀</p></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Data Lab Tech" src=/img/avatar_hu14365428751860151861.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Data Lab Tech</div><div class="text-sm text-neutral-700 dark:text-neutral-400"><a href=https://youtube.com/@DataLabTechTV target=_blank>https://youtube.com/@DataLabTechTV</a></div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://youtube.com/@DataLabTechTV target=_blank aria-label=Youtube rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://bsky.app/profile/datalabtechtv.com target=_blank aria-label=Bluesky rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/DataLabTechTV target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://discord.gg/6xpe827ANZ target=_blank aria-label=Discord rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentcolor" d="M524.531 69.836a1.5 1.5.0 00-.764-.7A485.065 485.065.0 00404.081 32.03a1.816 1.816.0 00-1.923.91 337.461 337.461.0 00-14.9 30.6 447.848 447.848.0 00-134.426.0 309.541 309.541.0 00-15.135-30.6 1.89 1.89.0 00-1.924-.91A483.689 483.689.0 00116.085 69.137a1.712 1.712.0 00-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016.0 00.765 1.375A487.666 487.666.0 00176.02 479.918a1.9 1.9.0 002.063-.676A348.2 348.2.0 00208.12 430.4a1.86 1.86.0 00-1.019-2.588 321.173 321.173.0 01-45.868-21.853 1.885 1.885.0 01-.185-3.126c3.082-2.309 6.166-4.711 9.109-7.137a1.819 1.819.0 011.9-.256c96.229 43.917 200.41 43.917 295.5.0a1.812 1.812.0 011.924.233c2.944 2.426 6.027 4.851 9.132 7.16a1.884 1.884.0 01-.162 3.126 301.407 301.407.0 01-45.89 21.83 1.875 1.875.0 00-1 2.611 391.055 391.055.0 0030.014 48.815 1.864 1.864.0 002.063.7A486.048 486.048.0 00610.7 405.729a1.882 1.882.0 00.765-1.352C623.729 277.594 590.933 167.465 524.531 69.836zM222.491 337.58c-28.972.0-52.844-26.587-52.844-59.239S193.056 219.1 222.491 219.1c29.665.0 53.306 26.82 52.843 59.239.0 32.654-23.41 59.241-52.843 59.241zm195.38.0c-28.971.0-52.843-26.587-52.843-59.239S388.437 219.1 417.871 219.1c29.667.0 53.307 26.82 52.844 59.239.0 32.654-23.177 59.241-52.844 59.241z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:mail@datalabtechtv.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-10></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/&amp;title=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface+https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/" title="Post on Bluesky" aria-label="Post on Bluesky"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://s2f.kytta.dev/?text=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface%20https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/&amp;resubmit=true&amp;title=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface" title="Submit to Reddit" aria-label="Submit to Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/&amp;quote=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface" title="Share on Facebook" aria-label="Share on Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/&amp;subject=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface" title="Send via email" aria-label="Send via email"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/&amp;resubmit=true&amp;title=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface" title="Share via WhatsApp" aria-label="Share via WhatsApp"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://datalabtechtv.com/posts/labstore-part-5-cli-tooling/&amp;resubmit=true&amp;title=LabStore%20-%20Part%205%20-%20Building%20an%20Object%20Store%20in%20Go:%20CLI%20-%20Command%20Line%20Interface" title="Share via Telegram" aria-label="Share via Telegram"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></section></div><script>var oid="views_posts/labstore-part-5-cli-tooling/index.md",oid_likes="likes_posts/labstore-part-5-cli-tooling/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/labstore-part-4-iam-service/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-12-23T12:00:00+01:00>23 December 2025</time>
</span></span></a></span><span></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 mt-8 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/privacy/ title>Privacy</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/cookies/ title>Cookies</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a id=reset-cookie-options class="decoration-primary-500 flex items-center" href=# title="Reset Cookie Options"><span class=mr-1>🍪</span></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Data Lab Tech</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script><script src=/js/search-keybind.min.b0547e1bcfb3922a05d78728999bbd36902e6c52a31b0b1efa373df47c6fa095.js integrity="sha256-sFR+G8+zkioF14comZu9NpAubFKjGwse+jc99HxvoJU=" crossorigin=anonymous></script><script src=/js/cookie-banner.min.010e183607b0d0550c6b0c6cdfee0ef6a8251e4995f06db7c9541c7a847f9751.js integrity="sha256-AQ4YNgew0FUMawxs3+4O9qglHkmV8G23yVQceoR/l1E=" crossorigin=anonymous></script><div id=cookie-spacer class="h-12 hidden"></div><div id=cookie-banner class="fixed inset-x-0 bottom-0 z-[90] hidden"><div class="opacity-90 backdrop-blur-2xl shadow-2xl px-4 py-4 text-sm text-white dark:text-neutral-100"><div class="max-w-[64rem] mx-auto flex flex-wrap items-center justify-between gap-4"><span>We use cookies to enhance your experience.
<a href=/privacy/ class="underline text-blue-300 hover:text-blue-100 ml-1">Learn more</a>.</span><div class="flex gap-4 shrink-0"><button id=cookie-decline class="font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400 cursor-pointer">
Decline
</button>
<button id=cookie-accept class="font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400 cursor-pointer">
Accept</button></div></div></div></div><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        theme: "base",
        themeCSS: `
          /* Left-align text in class diagrams */
          .nodeLabel {
            text-wrap: nowrap;
          }
        `,
        flowchart: {
            nodeSpacing: 20,
            rankSpacing: 100,
        },
        themeVariables: {
            fontFamily: 'var(--default-mono-font-family, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace)',
            fontSize: "1.5em",

            background: "#1e1e1e",
            textColor: "#f8fafc",
            primaryColor: "#0ea5e9",
            tertiaryColor: "#f8fafc",
            primaryTextColor: "#1e1e1e",
            lineColor: "#94a3b8",
            noteBkgColor: "#2c3a4a",

             
            nodeBorder: "#38bdf8",
            clusterBkg: "#2c3a4a",
            clusterBorder: "#4b5563",

             
            actorTextColor: "#f8fafc",
            loopTextColor: "#f8fafc",

             
            tagLabelFontSize: ".6em",
            commitLabelFontSize: ".6em",
            commitLabelColor: "#f8fafc",
            commitLabelBackground: "#2c3a4a",
            git0: "#0ea5e9",
            git1: "#4b5563",
        }
    });
</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://datalabtechtv.com/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>