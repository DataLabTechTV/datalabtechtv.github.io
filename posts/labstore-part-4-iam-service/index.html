<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management &#183; Data Lab Tech TV</title>
<meta name=title content="LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management &#183; Data Lab Tech TV"><meta name=description content="Building an IAM service on top of SQLite in Go, from config handling to proper secret encryption."><meta name=keywords content="iam,s3,go,object-store,aws,authentication,video,"><link rel=canonical href=https://datalabtechtv.com/posts/labstore-part-4-iam-service/><link type=text/css rel=stylesheet href=/css/main.bundle.min.36c3cd7950e4533fa7da3150d972e3edf34d07f83c0264ff04cad0969dfdb3b8a7065b0ed6c730c6d34a7bad516cfc6f6a5917ab1fdb10b25f481f8a17b54c16.css integrity="sha512-NsPNeVDkUz+n2jFQ2XLj7fNNB/g8AmT/BMrQlp39s7inBlsO1scwxtNKe61RbPxvalkXqx/bELJfSB+KF7VMFg=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.52b8d61b061c90a738102a0eac69eaa1479fdf5de882a0b0741d7515240617156a6c4477fcc91f9c962062804fe62d2932bb9f57d0aded208c762c2e1ed2e202.js integrity="sha512-UrjWGwYckKc4ECoOrGnqoUef313ogqCwdB11FSQGFxVqbER3/MkfnJYgYoBP5i0pMrufV9Ct7SCMdiwuHtLiAg==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://datalabtechtv.com/posts/labstore-part-4-iam-service/"><meta property="og:site_name" content="Data Lab Tech TV"><meta property="og:title" content="LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management"><meta property="og:description" content="Building an IAM service on top of SQLite in Go, from config handling to proper secret encryption."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-23T12:00:00+01:00"><meta property="article:modified_time" content="2025-12-23T12:00:00+01:00"><meta property="article:tag" content="Iam"><meta property="article:tag" content="S3"><meta property="article:tag" content="Go"><meta property="article:tag" content="Object-Store"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Authentication"><meta property="og:image" content="https://datalabtechtv.com/posts/labstore-part-4-iam-service/feature.jpeg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://datalabtechtv.com/posts/labstore-part-4-iam-service/feature.jpeg"><meta name=twitter:title content="LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management"><meta name=twitter:description content="Building an IAM service on top of SQLite in Go, from config handling to proper secret encryption."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management","headline":"LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management","description":"Building an IAM service on top of SQLite in Go, from config handling to proper secret encryption.","abstract":"Summary # Learn how to build an IAM service on top of SQLite in Go, from config handling to proper secret encryption.","inLanguage":"en","url":"https:\/\/datalabtechtv.com\/posts\/labstore-part-4-iam-service\/","author":{"@type":"Person","name":"Data Lab Tech"},"copyrightYear":"2025","dateCreated":"2025-12-23T12:00:00\u002b01:00","datePublished":"2025-12-23T12:00:00\u002b01:00","dateModified":"2025-12-23T12:00:00\u002b01:00","keywords":["iam","s3","go","object-store","aws","authentication","video"],"mainEntityOfPage":"true","wordCount":"4182"}]</script><meta name=author content="Data Lab Tech"><link href=https://youtube.com/@DataLabTechTV rel=me><link href=https://bsky.app/profile/datalabtechtv.com rel=me><link href=https://github.com/DataLabTechTV rel=me><link href=https://discord.gg/6xpe827ANZ rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VQTLJTJJ7T"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied"}),gtag("js",new Date),gtag("config","G-VQTLJTJJ7T",{anonymize_ip:!0,allow_google_signals:!1})</script><script>MathJax={tex:{inlineMath:[["$","$"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js></script><style>.medium-zoom-overlay{background:rgba(0,0,0,.9)!important;z-index:100}.of-wide{width:150%;margin-left:-25%;height:auto}.of-narrow{width:125%;height:auto}</style><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 min-h-[130px] opacity-65 pl-[24px] pr-[24px] bg-gradient-to-b from-neutral from-60% dark:from-neutral-800 to-transparent mix-blend-normal" style=z-index:80></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div><a href=/ class=flex><span class=sr-only>Data Lab Tech TV</span>
<img src=/img/logo.png width=450 height=450 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Data Lab Tech TV"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Data Lab Tech TV</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Blog</p></a><a href=https://youtube.com/@DataLabTechTV target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></span><p class="text-base font-medium" title>YouTube</p></a><a href=https://bsky.app/profile/datalabtechtv.com target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></span><p class="text-base font-medium" title>Bluesky</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><div><div class="cursor-pointer flex items-center nested-menu"><a class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title>Categories
</a><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/categories/data-science/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Data Science</p></a><a href=/categories/data-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Data Engineering</p></a><a href=/categories/mlops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>MLOps</p></a><a href=/categories/devops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>DevOps</p></a><a href=/categories/software-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Software Engineering</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" style=white-space:nowrap title>Philosophy of Technology</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Blog</p></a></li><li class=mt-1><a href=https://youtube.com/@DataLabTechTV target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></div><p class="text-bg font-bg" title>YouTube</p></a></li><li class=mt-1><a href=https://bsky.app/profile/datalabtechtv.com target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></div><p class="text-bg font-bg" title>Bluesky</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Categories</p><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=/categories/data-science/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Data Science</p></a></li><li class=mt-1><a href=/categories/data-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Data Engineering</p></a></li><li class=mt-1><a href=/categories/mlops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>MLOps</p></a></li><li class=mt-1><a href=/categories/devops/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>DevOps</p></a></li><li class=mt-1><a href=/categories/software-engineering/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Software Engineering</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Philosophy of Technology</p></a></li><li class=mb-2></li></ul></div></label></div></div></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/img/background_hu5250322968290309648.png)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-30 dark:opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">LabStore - Part 4 - Building an Object Store in Go: IAM - Identity and Access Management</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-12-23T12:00:00+01:00>23 December 2025</time><span class="px-2 text-primary-500">&#183;</span><span>4182 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">20 mins</span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/categories/software-engineering/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Software Engineering
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/iam/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Iam
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/s3/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">S3
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/go/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Go
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/object-store/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Object-Store
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/aws/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Aws
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/authentication/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Authentication
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/video/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Video</span></span></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#introducing-iam>Introducing IAM</a><ul><li><a href=#minimum-viable-actions>Minimum Viable Actions</a></li><li><a href=#policy-document>Policy Document</a></li></ul></li><li><a href=#backend-configuration>Backend Configuration</a><ul><li><a href=#storage-changes>Storage Changes</a></li><li><a href=#iam-db-configs>IAM DB Configs</a></li></ul></li><li><a href=#implementing-iam>Implementing IAM</a><ul><li><a href=#database>Database</a><ul><li><a href=#schema>Schema</a></li><li><a href=#pragmas>PRAGMAs</a></li><li><a href=#connections>Connections</a></li><li><a href=#store>Store</a></li></ul></li><li><a href=#security-and-encryption>Security and Encryption</a></li><li><a href=#business-logic-and-http-handlers>Business Logic and HTTP Handlers</a><ul><li><a href=#createpolicy-example>CreatePolicy Example</a></li><li><a href=#iam-middleware>IAM Middleware</a></li></ul></li><li><a href=#manual-testing>Manual Testing</a></li></ul></li><li><a href=#go-tip-of-the-day>Go Tip of the Day</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#introducing-iam>Introducing IAM</a><ul><li><a href=#minimum-viable-actions>Minimum Viable Actions</a></li><li><a href=#policy-document>Policy Document</a></li></ul></li><li><a href=#backend-configuration>Backend Configuration</a><ul><li><a href=#storage-changes>Storage Changes</a></li><li><a href=#iam-db-configs>IAM DB Configs</a></li></ul></li><li><a href=#implementing-iam>Implementing IAM</a><ul><li><a href=#database>Database</a><ul><li><a href=#schema>Schema</a></li><li><a href=#pragmas>PRAGMAs</a></li><li><a href=#connections>Connections</a></li><li><a href=#store>Store</a></li></ul></li><li><a href=#security-and-encryption>Security and Encryption</a></li><li><a href=#business-logic-and-http-handlers>Business Logic and HTTP Handlers</a><ul><li><a href=#createpolicy-example>CreatePolicy Example</a></li><li><a href=#iam-middleware>IAM Middleware</a></li></ul></li><li><a href=#manual-testing>Manual Testing</a></li></ul></li><li><a href=#go-tip-of-the-day>Go Tip of the Day</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">Summary<div id=summary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h2><p>Learn how to build an IAM service on top of SQLite in Go, from config handling to proper secret encryption. We&rsquo;ll cover the required actions to implement an MVP, and SQLite pragmas and patterns to ensure performance. You&rsquo;ll learn how to design the database schema for IAM, and how to implement SQLite CRUD in Go, with concurrency, using buffered channels. We&rsquo;ll also touch on symmetric encryption, based on 256-bit AES-GCM, for secure secret storage, and describe our approach to organizing business logic and HTTP handlers, while also touching on interesting JSON marshaling details that arose during development.</p><p>Follow this series with IllumiKnow Labs, and let&rsquo;s see where this journey takes us. Hopefully you&rsquo;ll learn a lot along the way!</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%><iframe src=https://www.youtube.com/embed/C5nCE5tOhLQ frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin allowfullscreen style=position:absolute;top:0;left:0;width:100%;height:100%>></iframe></div><h2 class="relative group">Introducing IAM<div id=introducing-iam class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introducing-iam aria-label=Anchor>#</a></span></h2><p>An IAM API essentially handles CRUD operations for users, groups, and policies. Users can have access keys to access the S3 service, and they can also belong to groups. Policies are used for access control, and they can be attached to users or groups. IAM also supports inline or embedded policies, directly added to users or groups, but we do not support this option for now.</p><h3 class="relative group">Minimum Viable Actions<div id=minimum-viable-actions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#minimum-viable-actions aria-label=Anchor>#</a></span></h3><p>After a few iterations, we ended up with the follow list of IAM actions, for which we provide working but partial implementations:</p><ul><li>We only provide a single access key per user, matching the username, and providing a randomly generated secret key (overridden on subsequent creation requests);</li><li>We do not support all response fields or errors;</li><li>The IAM service is unprotected (i.e., there is no authentication, so it needs to be secured, for example behind a reverse proxy with TLS and HTTP auth).</li></ul><p>Regardless, the existing IAM implementation is enough to do most tasks, and we&rsquo;re quite happy with it, given that our target was to reach an MVP.</p><p>Below is an overview of the IAM actions that we support in LabStore, with links to the respective pages in the official AWS IAM documentation:</p><ul><li>Users<ul><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateUser.html target=_blank>CreateUser</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateAccessKey.html target=_blank>CreateAccessKey</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetUser.html target=_blank>GetUser</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListAccessKeys.html target=_blank>ListAccessKeys</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteUser.html target=_blank>DeleteUser</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteAccessKey.html target=_blank>DeleteAccessKey</a></li></ul></li><li>Groups<ul><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateGroup.html target=_blank>CreateGroup</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html target=_blank>AddUserToGroup</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetGroup.html target=_blank>GetGroup</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteGroup.html target=_blank>DeleteGroup</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_RemoveUserFromGroup.html target=_blank>RemoveUserFromGroup</a></li></ul></li><li>Policies<ul><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreatePolicy.html target=_blank>CreatePolicy</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_AttachUserPolicy.html target=_blank>AttachUserPolicy</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_AttachGroupPolicy.html target=_blank>AttachGroupPolicy</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetPolicy.html target=_blank>GetPolicy</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListAttachedUserPolicies.html target=_blank>ListAttachedUserPolicies</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListAttachedGroupPolicies.html target=_blank>ListAttachedGroupPolicies</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeletePolicy.html target=_blank>DeletePolicy</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_DetachUserPolicy.html target=_blank>DetachUserPolicy</a></li><li><a href=https://docs.aws.amazon.com/IAM/latest/APIReference/API_DetachGroupPolicy.html target=_blank>DetachGroupPolicy</a></li></ul></li></ul><h3 class="relative group">Policy Document<div id=policy-document class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#policy-document aria-label=Anchor>#</a></span></h3><p>A policy is defined by a JSON document with the following format:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;s3:ListAllMyBuckets&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;s3:Get*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;s3:List*&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;arn:aws:s3:::test-bucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;arn:aws:s3:::test-bucket/*&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We support both <code>Allow</code> and <code>Deny</code> effects, AWS-compatible ARN identifiers for resource names, and the following S3 actions:</p><ul><li><code>*</code> – matches all actions</li><li><code>s3:ListAllMyBuckets</code></li><li><code>s3:CreateBucket</code></li><li><code>s3:DeleteBucket</code></li><li><code>s3:ListBucket</code></li><li><code>s3:PutObject</code></li><li><code>s3:GetObject</code></li><li><code>s3:DeleteObject</code></li></ul><p>We also support globbing for resources (e.g., <code>arn:aws:s3:::test-bucket/*</code>) and actions (e.g., <code>s3:Get*</code>).</p><h2 class="relative group">Backend Configuration<div id=backend-configuration class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#backend-configuration aria-label=Anchor>#</a></span></h2><p>We implemented the <a href=https://github.com/IllumiKnowLabs/labstore/blob/fd579886846c42f5bb7c464e2f09123d6df52a13/backend/internal/config/config.go target=_blank>LabStore configuration</a> for IAM via <a href=https://github.com/spf13/viper target=_blank>spf13/viper</a>, with lower priority for defaults, followed by the <a href=https://github.com/IllumiKnowLabs/labstore/blob/fd579886846c42f5bb7c464e2f09123d6df52a13/labstore.example.yml target=_blank>labstore.yml</a> config file, environment variables, and, with the highest priority, command line arguments.</p><p>In order to keep it simple, we use a consistent naming convention across config sources. For example, if we&rsquo;re setting <code>backend</code> configs, which are used by the <code>labstore-server</code> command, then a setting like <code>backend.storage.data_dir</code> in the YAML file can be overridden by <code>LABSTORE_BACKEND_STORAGE_DATA_DIR</code>, where <code>LABSTORE_</code> is the prefix for all LabStore configs set via env vars. We can also override the env var using the CLI, but this time, since the context is not ambiguous (e.g., for <code>labstore-server</code> we know we&rsquo;re handling LabStore backend configs), we only use <code>--storage-data-dir</code> without any prefix . This behavior is consistent across the application—in summary, for env vars we add a prefix to avoid potential collisions with other program environments, and for the CLI we remove the unrequired prefix to make arguments more manageable, but, regardless, we always name configs consistently across all sources.</p><p>Below is an example for the <code>backend</code> config. We also have three other sections, which we do not cover here, named <code>web</code>, <code>shared</code>, and <code>benchmark</code> (covered on the <a href=https://youtu.be/1KK4ibyqG2s target=_blank>previous video</a>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>data_dir</span><span class=p>:</span><span class=w> </span><span class=l>./data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>keys_dir</span><span class=p>:</span><span class=w> </span><span class=l>./keys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>admin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6787</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>auth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>access_key</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secret_key</span><span class=p>:</span><span class=w> </span><span class=l>adminadmin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>iam</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6788</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max_open_conns</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max_idle_conns</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>write_chan_cap</span><span class=p>:</span><span class=w> </span><span class=m>32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout_ms</span><span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>read_cache_size_kib</span><span class=p>:</span><span class=w> </span><span class=m>65536</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>writer_cache_size_kib</span><span class=p>:</span><span class=w> </span><span class=m>16384</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>s3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6789</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max_keys</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>io</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>buffer_size</span><span class=p>:</span><span class=w> </span><span class=m>262144</span><span class=w>
</span></span></span></code></pre></div><p>Notice that we moved the storage configs into its own namespace, and created separate namespaces for the <code>admin</code>, <code>iam</code>, and <code>s3</code> servers. The admin server only provides a health check endpoint currently, but we plan to use it in the future for other LabStore-specific tasks. The S3 server exposes our object store through an S3-compatible API. Finally, the IAM server, that we introduce here today, provides a subset of AWS IAM compatible endpoints to help manage users, groups, and policies.</p><h3 class="relative group">Storage Changes<div id=storage-changes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#storage-changes aria-label=Anchor>#</a></span></h3><p>The directory structure has also evolved to make room for the IAM requirements. We now configure a <code>data_dir</code> and a <code>keys_dir</code>.</p><ul><li>While objects were previously stored directly on the <code>data_dir</code>, they are now stored in an <code>objects/</code> subdirectory inside the <code>data_dir</code>.</li><li>We added a new <code>metadata/</code> subdirectory to the <code>data_dir</code>, which will contain the <code>iam.db</code> SQLite database.</li><li>We also set a separate <code>keys_dir</code> to store cryptographic keys—these should be backed up separately. More on this topic below, under the <a href=#security>Security</a> section.</li></ul><h3 class="relative group">IAM DB Configs<div id=iam-db-configs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#iam-db-configs aria-label=Anchor>#</a></span></h3><p>Notice that there are a few settings under <code>backend.iam.db</code> that let you customize your SQLite IAM database:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>max_open_conns</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>max_idle_conns</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>write_chan_cap</span><span class=p>:</span><span class=w> </span><span class=m>32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>timeout_ms</span><span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>read_cache_size_kib</span><span class=p>:</span><span class=w> </span><span class=m>65536</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>writer_cache_size_kib</span><span class=p>:</span><span class=w> </span><span class=m>16384</span><span class=w>
</span></span></span></code></pre></div><ul><li><code>max_open_conns</code> / <code>max_idle_conns</code> – control the SQLite reader connections—how many can be open or remain idle at a time, before reads are blocked or idle connections are closed.</li><li><code>write_chan_cap</code> – determines the size of the buffered channel that consumes write queries—once the limit is reached, requests will block; we do not have a channel timeout yet.</li><li><code>timeout_ms</code> – used to timeout a SQLite connection when there are no connections available to handle the request—either <code>max_open_conns</code> is reached for readers, or the channel is full for writers.</li><li><code>read_cache_size_kib</code> / <code>writer_cache_size_kib</code> – SQLite cache size for readers and for the writer.</li></ul><h2 class="relative group">Implementing IAM<div id=implementing-iam class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implementing-iam aria-label=Anchor>#</a></span></h2><p>We implement <a href=https://github.com/IllumiKnowLabs/labstore/blob/release/backend/v0.1.0/backend/internal/router/iam.go target=_blank>IAM as separate service in LabStore</a>, and we integrate it in the S3-compatible service through a <a href=https://github.com/IllumiKnowLabs/labstore/blob/release/backend/v0.1.0/backend/internal/middleware/iam.go target=_blank>custom middleware</a> for which we had already created a placeholder. Storage is completely supported on SQLite, which is embedded into the server—we might need a different solution, if we later expand LabStore to support multiple nodes, which will largely depend on the interest the project generates within the community, to justify expanding into distributed systems.</p><p>Next, we cover the database schema, as well as pragmas and the strategy we used to handle connections for reading an writing. Since we&rsquo;re working with credentials, we also cover our security approach openly, so that it has a change to be scrutinized. Finally, we cover the business logic and HTTP requests, focusing on the data types and errors that we implemented in Go. And we close with our manual testing strategy, an area that will need some attention in the future, to make the project more accessible to external contributions.</p><h3 class="relative group">Database<div id=database class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#database aria-label=Anchor>#</a></span></h3><p>When the server is first started, it will ensure that the database exists under <code>/data/metadata/iam.db</code> (assuming that <code>/data</code> is our <code>backend.storage.data_dir</code>).</p><h4 class="relative group">Schema<div id=schema class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#schema aria-label=Anchor>#</a></span></h4><p>Our <a href=https://github.com/IllumiKnowLabs/labstore/blob/fd579886846c42f5bb7c464e2f09123d6df52a13/backend/internal/iam/store.go#L171 target=_blank>database schema</a> is relatively straightforward, as we can see in the <acronym title="Entity-Relationship Diagram">ERD</acronym> below:</p><pre class=mermaid>
---
title: IAM SQLite Database Schema
---
erDiagram
    users {
	    TEXT user_id PK
	    TEXT name UK
	    TEXT arn UK
	    TEXT access_key
	    BLOB secret_key
    }
    groups {
		TEXT group_id PK
		TEXT name UK
		TEXT arn UK
	}
	policies {
		TEXT policy_id PK
		TEXT name UK
		TEXT arn UK
		JSON document "NOT NULL"
		DATETIME created_at "NOT NULL DEFAULT (CURRENT_TIMESTAMP)"
		DATETIME updated_at "NOT NULL DEFAULT (CURRENT_TIMESTAMP)"
	}

    users }o--o{ groups : member
    users }o--o{ policies : attaches
    groups }o--o{ policies : attaches
</pre><p>The main entity tables are created as follows, each with a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids target=_blank>unique identifier</a>, unique name, and <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/reference-arns.html target=_blank>unique ARN</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>user_id</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>arn</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>access_key</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>secret_key</span><span class=w> </span><span class=nb>BLOB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>groups</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>group_id</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>arn</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>policies</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>policy_id</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>arn</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>document</span><span class=w> </span><span class=n>JSON</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>created_at</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=p>(</span><span class=k>CURRENT_TIMESTAMP</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>updated_at</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=p>(</span><span class=k>CURRENT_TIMESTAMP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>For <code>policies</code>, we also store the policy <code>document</code> which is <code>JSON</code> / <code>TEXT</code>, alongside the <code>created_at</code> and <code>updated_at</code> <code>DATETIME</code> fields. Both of the <code>DATETIME</code> fields are set via defaults or through the following trigger:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TRIGGER</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>policies_update_trigger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AFTER</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>policies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FOR</span><span class=w> </span><span class=k>EACH</span><span class=w> </span><span class=k>ROW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>UPDATE</span><span class=w> </span><span class=n>policies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=n>updated_at</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHERE</span><span class=w> </span><span class=n>policy_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>OLD</span><span class=p>.</span><span class=n>policy_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Finally, as shown below, we also define three junction tables for the many-to-many relationships defining <code>group_users</code>, <code>user_policies</code>, and <code>group_policies</code>. Since we use foreign key checks, we also define those alongside cascading rules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>group_users</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>group_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>user_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span><span class=w> </span><span class=n>user_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>group_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>REFERENCES</span><span class=w> </span><span class=n>groups</span><span class=p>(</span><span class=n>group_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>user_policies</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>user_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>policy_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>policy_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>policy_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>REFERENCES</span><span class=w> </span><span class=n>policies</span><span class=p>(</span><span class=n>policy_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>group_policies</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>group_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>policy_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span><span class=w> </span><span class=n>policy_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>group_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>REFERENCES</span><span class=w> </span><span class=n>groups</span><span class=p>(</span><span class=n>group_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>policy_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>REFERENCES</span><span class=w> </span><span class=n>policies</span><span class=p>(</span><span class=n>policy_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CASCADE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h4 class="relative group">PRAGMAs<div id=pragmas class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pragmas aria-label=Anchor>#</a></span></h4><p>Database connections are opened with the following <a href=https://www.sqlite.org/pragma.html target=_blank>pragmas</a>, with a slight difference in <code>cache_size</code> between the reader and writer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>PRAGMA</span><span class=w> </span><span class=n>journal_mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WAL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PRAGMA</span><span class=w> </span><span class=n>synchronous</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NORMAL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PRAGMA</span><span class=w> </span><span class=n>temp_store</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MEMORY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PRAGMA</span><span class=w> </span><span class=n>cache_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>65536</span><span class=p>;</span><span class=w> </span><span class=c1>-- 64 MiB; or 16MiB for writer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PRAGMA</span><span class=w> </span><span class=n>locking_mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NORMAL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PRAGMA</span><span class=w> </span><span class=n>foreign_keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ON</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PRAGMA</span><span class=w> </span><span class=n>busy_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5000</span><span class=p>;</span><span class=w> </span><span class=c1>-- 5s
</span></span></span></code></pre></div><p>We use <code>WAL</code> mode to enable a write-ahead log, making it possible to use multiple readers and a single writer concurrently, without blocking.</p><p>We set <code>synchronous</code> to <code>NORMAL</code>, which controls how often <code>fsync</code>. The <code>NORMAL</code> mode ensures high performance and safety for the <code>WAL</code> mode, and an IAM service is also not write-intensive, but rather read-intensive.</p><p>Temporary tables and indices will be stored in <code>MEMORY</code>, according to the <code>temp_store</code> pragma.</p><p>By default, we use 64 MiB of cache for a default pool of three readers, or 16 MiB of cache for the single writer. These can, however, be set through the config.</p><p>We connect in <code>NORMAL</code> <code>locking_mode</code>—the only other option would be <code>EXCLUSIVE</code>, but we need concurrency here.</p><p>And, finally, we enable foreign key checks, and a timeout of 5 seconds when no connection is available.</p><h4 class="relative group">Connections<div id=connections class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#connections aria-label=Anchor>#</a></span></h4><p>We had to make a few decision regarding how to handle the connection to SQLite in Go:</p><ol><li>Library to handle querying (e.g., <a href=https://sqlc.dev/ target=_blank>sqlc</a>, <a href=https://jmoiron.github.io/sqlx/ target=_blank>sqlx</a>, etc.);</li><li>SQLite driver—C-based <a href=https://pkg.go.dev/github.com/mattn/go-sqlite3 target=_blank>mattn/go-sqlite3</a>, or pure Go <a href=https://pkg.go.dev/modernc.org/sqlite target=_blank>modernc.org/sqlite</a>;</li><li>Inline SQL queries or <a href=https://pkg.go.dev/embed target=_blank>embedded files</a>.</li></ol><p>Regarding decision 1, <code>sqlc</code> is a Go code generator that takes SQL files as input, producing methods that we can call directly for simple CRUD, while also supporting context. Since, in general, we do not like this kind of black box approach, so we ended up going with <code>sqlx</code>, which is a SQL query executor with a few helpers to integrate with data types, also supporting context—this is relevant to ensure that, when HTTP requests are cancelled, the SQL query is also aborted.</p><p>Regarding decision 2, while the C-based driver is considered the preferred approach, we didn&rsquo;t want to deal with the hassle of cross-compilation issues (we&rsquo;d need a C compiler to run in the target platform), so we went with the pure Go driver (this let&rsquo;s us compile for any platform locally, which is easier to manage; while the driver is slower, the IAM service won&rsquo;t be under immense load, specially given the self-hosting target audience for LabStore).</p><p>Finally, regarding decision 3, while we do appreciate the option to separate SQL in their own files, we went with inline SQL queries, since most of our queries are quite simple and small, with the exception of the schema creation SQL. In the future, we might rethink this decision, but the cost of migration is not too high—just move queries to their own SQL files and add a comment on top of a <code>query</code> string variable that points to the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//go:embed sql/file.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>query</span> <span class=kt>string</span>
</span></span></code></pre></div><h4 class="relative group">Store<div id=store class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#store aria-label=Anchor>#</a></span></h4><p>We define a <a href=https://github.com/IllumiKnowLabs/labstore/blob/fd579886846c42f5bb7c464e2f09123d6df52a13/backend/internal/iam/store.go#L171 target=_blank>Store</a> data type, where we handle all of our IAM-related queries. For reading concurrently, we define a <code>Store.readDB</code> variable with a connection pool that defaults to only three connections, but can be configured with a higher value for systems with available resources. For writing, we use a separate strategy based on a buffered channel—<code>Store.writeCh</code>—to mitigate potencial write blocks, given we are required to use a single writer. By default the buffer can hold 32 SQL tasks, but this can be configured as well.</p><p>The reader is accessed directly via <code>sqlx</code>—e.g., <code>store.readDB.SelectContext</code>. On the other hand, the writer is accessed either through specific unexported store methods—<code>store.sqlExecContext</code> and <code>store.sqlNamedExecContext</code>—or by sending a <code>sqlTask</code> into the <code>store.writeCh</code> task channel, containing a response channel. This is implemented as follows.</p><p>First, we define a <code>sqlTask</code> data type to wrap a <code>sqlFn</code>, containing the actual <code>sqlx</code> querying code, alongside a <code>uuid</code> to identify the request, the context, usually passed from the HTTP request, and the result channel, where we&rsquo;ll send a <code>sqlTaskResult</code> to.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sqlFn</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>db</span> <span class=o>*</span><span class=nx>sqlx</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=nx>sqlTaskResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sqlTask</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>uuid</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span>   <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span>
</span></span><span class=line><span class=cl>	<span class=nx>resCh</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=nx>sqlTaskResult</span>
</span></span><span class=line><span class=cl>	<span class=nx>fn</span>    <span class=nx>sqlFn</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>sqlTaskResult</code> data type will hold the tuple that is usually returned when running a query through <code>sqlx</code> methods:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sqlTaskResult</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sqlRes</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>Result</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span>    <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We also provide a constructor for <code>sqlTask</code> instances, which takes care of the UUID for us:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newSQLTask</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>resCh</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=nx>sqlTaskResult</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>fn</span> <span class=nx>sqlFn</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=nx>sqlTask</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>sqlTask</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>uuid</span><span class=p>:</span>  <span class=nx>uuid</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span><span class=p>:</span>   <span class=nx>ctx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>resCh</span><span class=p>:</span> <span class=nx>resCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fn</span><span class=p>:</span>    <span class=nx>fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And, finally, we construct our writer worker by calling the following function only once:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newWriterWorker</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sqlx</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=nx>sqlTask</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>slog</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;new writer worker&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;writeChanCap&#34;</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>IAM</span><span class=p>.</span><span class=nx>DB</span><span class=p>.</span><span class=nx>WriteChanCap</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>taskCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>sqlTask</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>IAM</span><span class=p>.</span><span class=nx>DB</span><span class=p>.</span><span class=nx>WriteChanCap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>task</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>taskCh</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>slog</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;sql write task&#34;</span><span class=p>,</span> <span class=s>&#34;uuid&#34;</span><span class=p>,</span> <span class=nx>task</span><span class=p>.</span><span class=nx>uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>sqlResp</span> <span class=o>:=</span> <span class=nx>task</span><span class=p>.</span><span class=nf>fn</span><span class=p>(</span><span class=nx>task</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>task</span><span class=p>.</span><span class=nx>resCh</span> <span class=o>&lt;-</span> <span class=nx>sqlResp</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>taskCh</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Notice that the goroutine wraps the <code>for</code> loop, ensuring that all tasks will be received concurrently, but handled sequentially by the writer (i.e., this is merely so that we can return from the function).</p><p>Any SQL tasks will then be sent to the <code>taskCh</code>, which is available as <code>Store.writeCh</code>. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>store</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>sqlExecContext</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>query</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>args</span> <span class=o>...</span><span class=nx>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>sql</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>resCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>sqlTaskResult</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>store</span><span class=p>.</span><span class=nx>writeCh</span> <span class=o>&lt;-</span> <span class=nf>newSQLTask</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>resCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>db</span> <span class=o>*</span><span class=nx>sqlx</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=nx>sqlTaskResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>ExecContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>args</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>sqlTaskResult</span><span class=p>{</span><span class=nx>sqlRes</span><span class=p>:</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>res</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>resCh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>sqlRes</span><span class=p>,</span> <span class=nx>res</span><span class=p>.</span><span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">Security and Encryption<div id=security-and-encryption class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#security-and-encryption aria-label=Anchor>#</a></span></h3><p>We need access to the plain text secret key to compute the <a href=https://docs.aws.amazon.com/AmazonS3/latest/API/sig-v4-header-based-auth.html target=_blank>SigV4</a> authorization header:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>dateKey</span> <span class=o>:=</span> <span class=nf>hmacSHA256</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;AWS4&#34;</span><span class=o>+</span><span class=nx>cred</span><span class=p>.</span><span class=nx>secretKey</span><span class=p>),</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>date</span><span class=p>))</span>
</span></span></code></pre></div><p>As you can see, this will be hashed with the <code>date</code>. So, while the secret key doesn&rsquo;t need to be transmitted in plain text, we&rsquo;ll need to have access to the plain text version both on the client and server sides.</p><p>As such, in order to secure secret keys, we use symmetrical encryption based on 256-bit AES-GCM. In turn, for this to be possible, we first generate a master key that we can use for encryption. This is created on the first startup for LabStore, and stored under the <code>backend.storage.keys_dir</code>, as defined in the config.</p><p>When migrating LabStore, make sure you backup the keys directory, and that your configs are pointing to the correct directory, otherwise a new master key will be produced, and subsequent secret keys encrypted with it. We currently provide no way to detect that a new master key, different from a previously used one, came into use, but this is possible to check with AES-GCM, and we might add it in the future for integrity insurance.</p><p>We generate a master key through the <code>iam.ensureMasterKey</code> method by calling the following functions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Produces a key with the given byte-length
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GenerateKey</span><span class=p>(</span><span class=nx>length</span> <span class=kt>int</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>key</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Produces a AES-256 master key (32 bytes)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GenerateMasterKey</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>GenerateKey</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Each secret key is then encrypted using this master key, as well as a nonce, which a unique salt-like value that is produced for each encryption operation. This is prepended to the ciphertext for the secret key and stored as a byte blob in the database.</p><p>Please notice that the IAM server is currently unprotected, so, if you deploy LabStore as is, please make sure that you put it behind an authenticated reverse proxy, protected by TLS and HTTP Auth. In the future, we&rsquo;ll protect the IAM service with the administrator credentials.</p><h3 class="relative group">Business Logic and HTTP Handlers<div id=business-logic-and-http-handlers class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#business-logic-and-http-handlers aria-label=Anchor>#</a></span></h3><p>Our business logic is mainly concerned with interacting with the database, and caching users, groups, or policies into our internal corresponding data types. HTTP handlers will then implement calls to this business logic, but they&rsquo;ll build the response separately, based on their own custom data types, defined according to the AWS IAM API.</p><p>We also define our own internal error types, as well as IAM errors, since our internal errors provide additional details that are not communicated through the IAM API—only IAM errors are XML encodable. This lets us log a more detailed error message, even when the returned IAM error is a general <code>ServiceFailure</code>. While we are now aware of the error handling workflow that should be implemented, this still needs a lot of work to reach the state that we want (e.g., we need to track the request ID when logging internal errors).</p><p>Most business logic is essentially CRUD, handled similarly across the IAM service. We opted to keep the business logic and the HTTP handler in the same file, as this matches our development workflow. We still keep them logically separate though, as we might need to implement similar requests via the CLI, or switch to a different HTTP handling approach in the future (less likely).</p><h4 class="relative group">CreatePolicy Example<div id=createpolicy-example class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#createpolicy-example aria-label=Anchor>#</a></span></h4><p>The business logic is quite extensive, so we&rsquo;ll not cover it all here, but we&rsquo;ll provide a concrete example below, based on <code>CreatePolicy</code>, starting from the <code>Store</code> data type, at the core of the IAM service.</p><h5 class="relative group">Data Types<div id=data-types class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#data-types aria-label=Anchor>#</a></span></h5><pre class=mermaid>
---
title: Class Diagram for the CreatePolicy IAM Action
---
classDiagram
	class Store {
		+CachedUsers : map[string]*CachedUser,
		+CachedGroups : map[string]*CachedGroup,
		+CachedPolicies : map[string]*CachedPolicy,
		+TTL : time.Duration
		-readDB : *sqlx.DB
		-writeCh : chan<- sqlTask

		+CreatePolicy(ctx context.Context, name string, doc *PolicyDocument) :&nbsp;(*Policy, error)
		+CreatePolicyHandler(w http.ResponseWriter, r *http.Request)
	}

	class CachedPolicy {
		+Policy : *Policy
		+LoadedAt : time.Time
		+NeverExpire : bool
	}

	class Policy {
		+PolicyID : string \`"db:"policy_id"\`
		+Name : string \`db:"name"\`
		+Arn : string \`db:"arn"\`
		+AttachmentCount : int
		+CreatedAt : time.Time \`db:"created_at"\`
		+UpdatedAt : time.Time \`db:"updated_at"\`
		+Document : *PolicyDocument \`db:"document"\`
	}

	class PolicyDocument {
		+Version : string
		+Statement : []Statement
	}

	class Statement {
		+Effect : Effect
		+Action : Actions
		+Resource: Resources
	}

	Store --> CachedPolicy
	CachedPolicy --> Policy
	Policy --> PolicyDocument
	PolicyDocument "1" --> "*" Statement
</pre><p>For the HTTP handler, we also define the following response types, inside the <code>iam</code> package, under <code>policies.go</code>, <code>policies_create.go</code> and <code>types.go</code>.</p><pre class=mermaid>
classDiagram
	class CreatePolicyResponse {
		+XMLName : xml.Name \`xml:"https\://iam.amazonaws.com/doc/2010-05-08/ CreatePolicyResponse"\`
		+CreatePolicyResult : *CreatePolicyResult
		+ResponseMetadata : *ResponseMetadata
	}

	class CreatePolicyResult {
		+Policy : *PolicyResult
	}

	class PolicyResult {
		+XMLName : xml.Name \`xml:"Policy"\`
		+PolicyName : string
		+DefaultVersionId : string
		+PolicyId : string
		+Path : string
		+Arn : string
		+AttachmentCount : int
		+CreateDate : time.Time
		+UpdateDate : time.Time
	}

	class ResponseMetadata {
		+RequestId : string
	}

	CreatePolicyResponse --> CreatePolicyResult
	CreatePolicyResponse --> ResponseMetadata
	CreatePolicyResult --> PolicyResult
</pre><h5 class="relative group">Internal and IAM Errors<div id=internal-and-iam-errors class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#internal-and-iam-errors aria-label=Anchor>#</a></span></h5><p>The HTTP handler also relies on the following errors, defined inside the <code>errs</code> package, under <code>iam.go</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>IAMServiceFailure</span><span class=p>()</span> <span class=o>*</span><span class=nx>IAMError</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>IAMError</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Type</span><span class=p>:</span>       <span class=nx>IAMReceiverType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Code</span><span class=p>:</span>       <span class=s>&#34;ServiceFailure&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Message</span><span class=p>:</span>    <span class=s>&#34;The request processing has failed because of an internal error.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>StatusCode</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>IAMEntityAlreadyExists</span><span class=p>(</span><span class=nx>entityName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>IAMError</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>IAMError</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Type</span><span class=p>:</span>       <span class=nx>IAMReceiverType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Code</span><span class=p>:</span>       <span class=s>&#34;EntityAlreadyExists&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Message</span><span class=p>:</span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;The entity %s already exists.&#34;</span><span class=p>,</span> <span class=nx>entityName</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>StatusCode</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusConflict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And we use a non-compliant error to handle missing query parameters (another one to improve in the future, under error handling):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>HTTPMissingQueryParam</span><span class=p>(</span><span class=nx>param</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;missing query parameter: %s&#34;</span><span class=p>,</span> <span class=nx>param</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 class="relative group">JSON Marshaling<div id=json-marshaling class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#json-marshaling aria-label=Anchor>#</a></span></h5><p>Both <code>Action</code> and <code>Resource</code> can be a single string or an array of strings, so they have their own types, <code>Actions</code> and <code>Resources</code>, so that we can handle this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Action</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3ListAllMyBuckets</span> <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:ListAllMyBuckets&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3CreateBucket</span>     <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:CreateBucket&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3DeleteBucket</span>     <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:DeleteBucket&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3ListBucket</span>       <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:ListBucket&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3PutObject</span>        <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:PutObject&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3GetObject</span>        <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:GetObject&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>S3DeleteObject</span>     <span class=nx>Action</span> <span class=p>=</span> <span class=s>&#34;s3:DeleteObject&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Actions</span> <span class=p>[]</span><span class=nx>Action</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>Actions</span><span class=p>)</span> <span class=nf>UnmarshalJSON</span><span class=p>(</span><span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>single</span> <span class=nx>Action</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>single</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=nx>a</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>Action</span><span class=p>{</span><span class=nx>single</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>multi</span> <span class=p>[]</span><span class=nx>Action</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>multi</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=nx>a</span> <span class=p>=</span> <span class=nx>multi</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Also notice that we use enum-like constants to store each supported action within our policies. These cover all of our existing S3 requests.</p><p>In order to properly store JSON in SQLite, we also needed to implement the following methods for <code>PolicyDocument</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pd</span> <span class=o>*</span><span class=nx>PolicyDocument</span><span class=p>)</span> <span class=nf>Value</span><span class=p>()</span> <span class=p>(</span><span class=nx>driver</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>pd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pd</span> <span class=o>*</span><span class=nx>PolicyDocument</span><span class=p>)</span> <span class=nf>Scan</span><span class=p>(</span><span class=nx>src</span> <span class=nx>any</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>src</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=nx>pd</span> <span class=p>=</span> <span class=nx>PolicyDocument</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>s</span> <span class=o>:=</span> <span class=nx>src</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>pd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=kt>string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>s</span><span class=p>),</span> <span class=nx>pd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unsupported type: %T&#34;</span><span class=p>,</span> <span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Notice that <code>s := src.(type)</code> is only valid inside a <code>switch</code> statement, where the <code>case</code> statements will match the type, and the <code>s</code> variable will contain the value cast to that type.</p><h4 class="relative group">IAM Middleware<div id=iam-middleware class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#iam-middleware aria-label=Anchor>#</a></span></h4><p>IAM policy checking is then done by the IAM middleware, establishing the correct permissions for each individual S3 request.</p><p>For example, for <code>GetObject</code>, we set the permissions, under <code>router/s3.go</code> as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;GET /{bucket}/{key...}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>middleware</span><span class=p>.</span><span class=nf>WithIAM</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>iam</span><span class=p>.</span><span class=nx>S3GetObject</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=nx>object</span><span class=p>.</span><span class=nx>GetObjectHandler</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>This is then handled by the IAM middleware under <code>middleware/iam.go</code>, which checks if the corresponding access key has the required permissions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>WithIAM</span><span class=p>(</span><span class=nx>action</span> <span class=nx>iam</span><span class=p>.</span><span class=nx>Action</span><span class=p>,</span> <span class=nx>next</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>slog</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;with iam&#34;</span><span class=p>,</span> <span class=s>&#34;action&#34;</span><span class=p>,</span> <span class=nx>action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>action</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>bucket</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>PathValue</span><span class=p>(</span><span class=s>&#34;bucket&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>PathValue</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>accessKey</span> <span class=o>:=</span> <span class=nf>GetRequestAccessKey</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>iam</span><span class=p>.</span><span class=nf>CheckPolicy</span><span class=p>(</span><span class=nx>accessKey</span><span class=p>,</span> <span class=nx>bucket</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>iam</span><span class=p>.</span><span class=nf>Action</span><span class=p>(</span><span class=nx>action</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>errs</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>errs</span><span class=p>.</span><span class=nf>S3AccessDenied</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>next</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>iam.CheckPolicy</code> function, defined in <a href=https://github.com/IllumiKnowLabs/labstore/blob/498c651ed73ca548403452eb278679f6fa86ac52/backend/internal/iam/iam.go#L38 target=_blank>iam/iam.go</a>, will match the resource given by <code>bucket</code> and <code>key</code>, as well as the requested <code>action</code>, with the policy stored in the <code>iam.Store</code>. If the access key has the required permissions, it will be allowed to continue.</p><h3 class="relative group">Manual Testing<div id=manual-testing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#manual-testing aria-label=Anchor>#</a></span></h3><p>For testing, we wanted to implement unit tests based on <code>net/http/httptest</code> for the REST API, as well as unit tests for the business logic <code>Store</code> methods. However, since we&rsquo;re working under a time constraint, to bring you this content at a decent pace, we scheduled this for <code>v0.2.0</code>.</p><p>During development, however, we relied heavily on scripted manual testing, directly based on <code>just</code> commands and <code>httpie</code> <code>POST</code> requests. Recently, we tried the official <code>aws</code> client, and it initially failed to work with the IAM endpoint, because we had used query parameters instead of form parameters. This has been fixed, and is already available on this week&rsquo;s <a href=https://github.com/IllumiKnowLabs/labstore/blob/498c651ed73ca548403452eb278679f6fa86ac52/backend/internal/router/iam.go#L48 target=_blank>release branch</a>.</p><p>In order to list all IAM testing commands, run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>just backend
</span></span></code></pre></div><p>And look at the <code>test-iam</code> group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>test-iam<span class=o>]</span>
</span></span><span class=line><span class=cl>test-iam-add-user-to-group
</span></span><span class=line><span class=cl>test-iam-attach-group-policy
</span></span><span class=line><span class=cl>test-iam-attach-user-policy
</span></span><span class=line><span class=cl>test-iam-create-access-key
</span></span><span class=line><span class=cl>test-iam-create-group
</span></span><span class=line><span class=cl>test-iam-create-policy
</span></span><span class=line><span class=cl>test-iam-create-user
</span></span><span class=line><span class=cl>test-iam-delete-access-key
</span></span><span class=line><span class=cl>test-iam-delete-group
</span></span><span class=line><span class=cl>test-iam-delete-policy
</span></span><span class=line><span class=cl>test-iam-delete-user
</span></span><span class=line><span class=cl>test-iam-detach-group-policy
</span></span><span class=line><span class=cl>test-iam-detach-user-policy
</span></span><span class=line><span class=cl>test-iam-get-group
</span></span><span class=line><span class=cl>test-iam-get-policy
</span></span><span class=line><span class=cl>test-iam-get-user
</span></span><span class=line><span class=cl>test-iam-group-policy
</span></span><span class=line><span class=cl>test-iam-list-access-keys
</span></span><span class=line><span class=cl>test-iam-list-attached-group-policies
</span></span><span class=line><span class=cl>test-iam-list-attached-user-policies
</span></span><span class=line><span class=cl>test-iam-remove-user-from-group
</span></span><span class=line><span class=cl>test-iam-user-policy
</span></span></code></pre></div><p>If you&rsquo;d like to test the API, make sure you have <code>just</code> and <code>httpie</code> installed, and try out this command for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>just backend::test-iam-group-policy
</span></span></code></pre></div><p>This will run several other commands, so it represents a moderately extensive testing of the IAM service:</p><pre tabindex=0><code class=language-just data-lang=just>[group(&#34;test-iam&#34;)]
test-iam-group-policy: test-iam-create-user \
	test-iam-create-access-key test-iam-create-group \
	test-iam-add-user-to-group test-iam-create-policy \
	test-iam-attach-group-policy
</code></pre><p>We rely the bucket, user, group, and policy preset as <code>justfile</code> variables—<code>test-bucket</code>, <code>test_user</code>, <code>test_group</code>, and <code>test-policy</code>. The policy document we set for <code>test-policy</code> is the one displayed in the <a href=#policy-document>Policy Document</a> section above.</p><h2 class="relative group">Go Tip of the Day<div id=go-tip-of-the-day class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#go-tip-of-the-day aria-label=Anchor>#</a></span></h2><p>At some point, we were trying to understand why the <code>go-sqlite3</code> dependency was being listed under <code>go.sum</code>—this is for the C-based SQLite driver that we opted not to use, so it shouldn&rsquo;t be there. If you hit a similar problem, here&rsquo;s my workflow.</p><p>First, I checked whether <code>go-sqlite3</code> was used in any of my source files using <a href=https://github.com/BurntSushi/ripgrep target=_blank>ripgrep</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rg go-sqlite3
</span></span></code></pre></div><p>This listed the match for <code>go.sum</code> as follows:</p><pre tabindex=0><code>go.sum
40:github.com/mattn/go-sqlite3 v1.14.22 h1:2gZY6PC6kBnID23Tichd1K+Z0oS6nE/XwU+Vz/5o4kU=
41:github.com/mattn/go-sqlite3 v1.14.22/go.mod h1:Uh1q+B4BYcTPb+yiD3kU8Ct7aC0hY9fxUwlHK0RXw+Y=
</code></pre><p>We then tried to understand if it was also listed in the dependency graph:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod graph <span class=p>|</span> grep go-sqlite3
</span></span></code></pre></div><p>And this output a single match for <code>sqlx</code>:</p><pre tabindex=0><code>github.com/jmoiron/sqlx@v1.4.0 github.com/mattn/go-sqlite3@v1.14.22
</code></pre><p>But the way we finally understood where this came from was through the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod why -m github.com/mattn/go-sqlite3
</span></span></code></pre></div><p>This outputs exactly the dependencies that lead to <code>go-sqlite3</code>:</p><pre tabindex=0><code>## github.com/mattn/go-sqlite3
github.com/IllumiKnowLabs/labstore/backend/internal/iam
github.com/jmoiron/sqlx
github.com/jmoiron/sqlx.test
github.com/mattn/go-sqlite3
</code></pre><p>This shows us exactly why <code>go-sqlite3</code> is included as a dependency: it is needed for testing under <code>sqlx.test</code>, which makes sense, and is unrelated to our code.</p></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Data Lab Tech" src=/img/avatar_hu14365428751860151861.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Data Lab Tech</div><div class="text-sm text-neutral-700 dark:text-neutral-400"><a href=https://youtube.com/@DataLabTechTV target=_blank>https://youtube.com/@DataLabTechTV</a></div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://youtube.com/@DataLabTechTV target=_blank aria-label=Youtube rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://bsky.app/profile/datalabtechtv.com target=_blank aria-label=Bluesky rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/DataLabTechTV target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://discord.gg/6xpe827ANZ target=_blank aria-label=Discord rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentcolor" d="M524.531 69.836a1.5 1.5.0 00-.764-.7A485.065 485.065.0 00404.081 32.03a1.816 1.816.0 00-1.923.91 337.461 337.461.0 00-14.9 30.6 447.848 447.848.0 00-134.426.0 309.541 309.541.0 00-15.135-30.6 1.89 1.89.0 00-1.924-.91A483.689 483.689.0 00116.085 69.137a1.712 1.712.0 00-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016.0 00.765 1.375A487.666 487.666.0 00176.02 479.918a1.9 1.9.0 002.063-.676A348.2 348.2.0 00208.12 430.4a1.86 1.86.0 00-1.019-2.588 321.173 321.173.0 01-45.868-21.853 1.885 1.885.0 01-.185-3.126c3.082-2.309 6.166-4.711 9.109-7.137a1.819 1.819.0 011.9-.256c96.229 43.917 200.41 43.917 295.5.0a1.812 1.812.0 011.924.233c2.944 2.426 6.027 4.851 9.132 7.16a1.884 1.884.0 01-.162 3.126 301.407 301.407.0 01-45.89 21.83 1.875 1.875.0 00-1 2.611 391.055 391.055.0 0030.014 48.815 1.864 1.864.0 002.063.7A486.048 486.048.0 00610.7 405.729a1.882 1.882.0 00.765-1.352C623.729 277.594 590.933 167.465 524.531 69.836zM222.491 337.58c-28.972.0-52.844-26.587-52.844-59.239S193.056 219.1 222.491 219.1c29.665.0 53.306 26.82 52.843 59.239.0 32.654-23.41 59.241-52.843 59.241zm195.38.0c-28.971.0-52.843-26.587-52.843-59.239S388.437 219.1 417.871 219.1c29.667.0 53.307 26.82 52.844 59.239.0 32.654-23.177 59.241-52.844 59.241z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:mail@datalabtechtv.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-10></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://datalabtechtv.com/posts/labstore-part-4-iam-service/&amp;title=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management+https://datalabtechtv.com/posts/labstore-part-4-iam-service/" title="Post on Bluesky" aria-label="Post on Bluesky"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://s2f.kytta.dev/?text=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management%20https://datalabtechtv.com/posts/labstore-part-4-iam-service/" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://datalabtechtv.com/posts/labstore-part-4-iam-service/&amp;resubmit=true&amp;title=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management" title="Submit to Reddit" aria-label="Submit to Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://datalabtechtv.com/posts/labstore-part-4-iam-service/&amp;quote=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management" title="Share on Facebook" aria-label="Share on Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://datalabtechtv.com/posts/labstore-part-4-iam-service/&amp;subject=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management" title="Send via email" aria-label="Send via email"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://datalabtechtv.com/posts/labstore-part-4-iam-service/&amp;resubmit=true&amp;title=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management" title="Share via WhatsApp" aria-label="Share via WhatsApp"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://datalabtechtv.com/posts/labstore-part-4-iam-service/&amp;resubmit=true&amp;title=LabStore%20-%20Part%204%20-%20Building%20an%20Object%20Store%20in%20Go:%20IAM%20-%20Identity%20and%20Access%20Management" title="Share via Telegram" aria-label="Share via Telegram"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></section></div><script>var oid="views_posts/labstore-part-4-iam-service/index.md",oid_likes="likes_posts/labstore-part-4-iam-service/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/labstore-part-3-benchmarking/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">LabStore - Part 3 - Building an Object Store in Go: Benchmarking and Profiling</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-12-09T12:00:00+01:00>9 December 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/labstore-part-5-cli-tooling/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">LabStore - Part 5 - Building an Object Store in Go: CLI - Command Line Interface</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-01-27T12:00:00+01:00>27 January 2026</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 mt-8 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/privacy/ title>Privacy</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/cookies/ title>Cookies</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a id=reset-cookie-options class="decoration-primary-500 flex items-center" href=# title="Reset Cookie Options"><span class=mr-1>🍪</span></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Data Lab Tech</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script><script src=/js/search-keybind.min.b0547e1bcfb3922a05d78728999bbd36902e6c52a31b0b1efa373df47c6fa095.js integrity="sha256-sFR+G8+zkioF14comZu9NpAubFKjGwse+jc99HxvoJU=" crossorigin=anonymous></script><script src=/js/cookie-banner.min.010e183607b0d0550c6b0c6cdfee0ef6a8251e4995f06db7c9541c7a847f9751.js integrity="sha256-AQ4YNgew0FUMawxs3+4O9qglHkmV8G23yVQceoR/l1E=" crossorigin=anonymous></script><div id=cookie-spacer class="h-12 hidden"></div><div id=cookie-banner class="fixed inset-x-0 bottom-0 z-[90] hidden"><div class="opacity-90 backdrop-blur-2xl shadow-2xl px-4 py-4 text-sm text-white dark:text-neutral-100"><div class="max-w-[64rem] mx-auto flex flex-wrap items-center justify-between gap-4"><span>We use cookies to enhance your experience.
<a href=/privacy/ class="underline text-blue-300 hover:text-blue-100 ml-1">Learn more</a>.</span><div class="flex gap-4 shrink-0"><button id=cookie-decline class="font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400 cursor-pointer">
Decline
</button>
<button id=cookie-accept class="font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400 cursor-pointer">
Accept</button></div></div></div></div><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        theme: "base",
        themeCSS: `
          /* Left-align text in class diagrams */
          .nodeLabel {
            text-wrap: nowrap;
          }
        `,
        flowchart: {
            nodeSpacing: 20,
            rankSpacing: 100,
        },
        themeVariables: {
            fontFamily: 'var(--default-mono-font-family, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace)',
            fontSize: "1.5em",

            background: "#1e1e1e",
            textColor: "#f8fafc",
            primaryColor: "#0ea5e9",
            tertiaryColor: "#f8fafc",
            primaryTextColor: "#1e1e1e",
            lineColor: "#94a3b8",
            noteBkgColor: "#2c3a4a",

             
            nodeBorder: "#38bdf8",
            clusterBkg: "#2c3a4a",
            clusterBorder: "#4b5563",

             
            actorTextColor: "#f8fafc",
            loopTextColor: "#f8fafc",

             
            tagLabelFontSize: ".6em",
            commitLabelFontSize: ".6em",
            commitLabelColor: "#f8fafc",
            commitLabelBackground: "#2c3a4a",
            git0: "#0ea5e9",
            git1: "#4b5563",
        }
    });
</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://datalabtechtv.com/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>